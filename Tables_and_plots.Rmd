---
title: "Tables_and_plots"
author: "Steven Bright"
date: "22/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean global environment}

remove(list = ls())

```

#Call libraries

```{r Install packages}

#install.packages("cowplot")
#install.packages("grid")
#install.packages("gridExtra")
#install.packages("gtsummary")
#install.packages("tidyverse")

```

```{r Load libraries}

library(cowplot)
library(grid)
library(gridExtra)
library(gtsummary)
library(tidyverse)

```

#Add colour palette

```{r Create colour palettes}

glad_coping_palette2 <- c("#EFC10B", "#B7DEE8")
glad_coping_palette3 <- c("#EFC10B", "#B7DEE8", "#0403ff")

```


#Source data paths

```{r Source paths}

source("..//COPING_participation_paths.r")

```

#Source functions

```{r Source functions}

source("..//COPING_participation_functions.r")

```

```{r Read in glad coping participation data}

glad_coping_participation <- read_rds(paste0(processed_data_path, processed_data_name))

#Check data
glad_coping_participation %>% 
  head()

```

#Plots: Participation in the COPING baseline

Will create individual plots of demographic variables before combining them into
one plot. This includes:

- Age
- Gender
- Employment
- Ethnic identity

```{r Plot age within the GLAD sign up for baseline completion}

age_group_plot <- glad_coping_participation %>% 
  ggplot(aes(x = age_groups_labelled, fill = completed_baseline_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Age (years)",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
age_group_plot

```

```{r Plot gender within the glad sign up for baseline completion}

gender_plot <- glad_coping_participation %>% 
  ggplot(aes(x = gender_recode_labelled, fill = completed_baseline_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Gender",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
gender_plot

```

```{r Plot employment in the GLAD sign up for baseline completion}

employment_plot <- glad_coping_participation %>% 
  drop_na(employment_labelled) %>% 
  ggplot(aes(x = employment_labelled, fill = completed_baseline_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Employment status",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
employment_plot

```

```{r Plot ethnicity in the GLAD sign up for baseline compeltion}

ethnicity_plot <- glad_coping_participation %>% 
  drop_na(ethnicity_labelled) %>% 
  ggplot(aes(x = ethnicity_labelled, fill = completed_baseline_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Ethnic identity",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
ethnicity_plot

```

```{r Plot ethnic minorities in the GLAD sign up for baseline completion}

ethnic_minority_plot <- glad_coping_participation %>% 
  drop_na(ethnicity_labelled) %>% 
  filter(ethnicity_labelled != "White") %>% 
  drop_na(ethnicity_labelled) %>% 
  ggplot(aes(x = ethnicity_labelled, fill = completed_baseline_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Ethnic minority identity",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
ethnic_minority_plot

```

##Create a combined plot

```{r Create plot layout matrix}

plot_layout_matrix <- matrix(c(1, 1, 2, 3, 3, 4), nrow = 2, byrow = TRUE)

#See matrix
plot_layout_matrix

```

```{r Create combined demograhics plot for baseline completion}

demographics_completed_baseline_plot <- grid.arrange(ethnic_minority_plot,
                                                     age_group_plot,
                                                     employment_plot,
                                                     gender_plot,
                                                     layout_matrix = plot_layout_matrix,
                                                     nrow = 2)

```

#Plots: Participation in the COPING follow-ups

For the plots, we will use a categorical N COPING surveys variable instead 
of the full count variable. Following plots will be created and then merged:

- Age
- Gender
- Employment
- Ethnicity

```{r Create age plot for COPING follow-up completion}

age_group_COPING_waves_plot <- glad_coping_participation %>% 
  ggplot(aes(x = age_groups_labelled, fill = total_COPING_waves_binary_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Age (years)",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette3) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
age_group_COPING_waves_plot

```

```{r Create Gender plot for COPING follow-up completion}

gender_COPING_waves_plot <- glad_coping_participation %>% 
  ggplot(aes(x = gender_recode_labelled, fill = total_COPING_waves_binary_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Gender",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
gender_COPING_waves_plot

```

```{r Create employment plot for COPING follow-up completion}

employment_COPING_waves_plot <- glad_coping_participation %>% 
  drop_na(employment_labelled) %>% 
  ggplot(aes(x = employment_labelled, fill = total_COPING_waves_binary_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Employment status",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
employment_COPING_waves_plot

```

```{r Create ethnicity plot for COPING follow-up completion}

ethnicity_COPING_waves_plot <- glad_coping_participation %>% 
  drop_na(ethnicity_labelled) %>% 
  ggplot(aes(x = ethnicity_labelled, fill = total_COPING_waves_binary_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Ethnic identity",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
ethnicity_COPING_waves_plot

```

```{r Create ethnic minorities plot for COPING follow-up completion}

ethnic_minority_COPING_waves_plot <- glad_coping_participation %>% 
  drop_na(ethnicity_labelled) %>% 
  filter(ethnicity_labelled != "White") %>% 
  drop_na(ethnicity_labelled) %>% 
  ggplot(aes(x = ethnicity_labelled, fill = total_COPING_waves_binary_labelled)) +
  geom_bar(position = "dodge") +
  labs(x = "Ethnic minority identity",
       y = "N participants") +
  scale_fill_manual(values = glad_coping_palette2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  theme_classic() +
  theme(legend.position = "none")

#Check plot
ethnic_minority_plot

```

##Combined COPING waves participation plot

```{r Create plot layout matrix}

COPING_waves_layout_matrix <- matrix(c(1, 1, 2, 3, 3, 4), nrow = 2, byrow = TRUE)

#See matrix
COPING_waves_layout_matrix

```

```{r Create combined COPING waves participation plot}

demographics_COPING_waves_plot <- grid.arrange(ethnic_minority_COPING_waves_plot,
                                                     age_group_COPING_waves_plot,
                                                     employment_COPING_waves_plot,
                                                     gender_COPING_waves_plot,
                                                     layout_matrix = COPING_waves_layout_matrix,
                                                     nrow = 2)

```

#Summary tables

Want to create x2 tables

- One summarising the sociodemographic and psychiatric characteristics of those
participants who did/didn't complete the COPING baseline

- One summarising the sociodemographics and psychiatric characteristics of those
participants who completed the follow-ups/baseline only participants

##COPING baseline participation table

```{r Get N counts for COPING baseline participation table}

#Note: Gender appears twice and sex also appears. Only gender should appear!
glad_coping_participation %>% 
  select(all_of(ends_with("_labelled")),
         -total_COPING_waves_labelled,
         -total_COPING_waves_binary_labelled) %>% 
  tbl_summary(missing_text = "Missing",
              by = "completed_baseline_labelled")

```

##COPING follow-ups

```{r Get N and percentage values for COPING follow-ups}

#Note: Marital status appears twice: fix this!
glad_coping_participation %>% 
  select(all_of(ends_with("_labelled")),
         -completed_baseline_labelled,
         -total_COPING_waves_labelled) %>% 
  tbl_summary(missing_text = "Missing",
              by = "total_COPING_waves_binary_labelled")

```


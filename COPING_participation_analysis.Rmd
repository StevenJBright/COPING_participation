---
title: "COPING_participation_analysis"
author: "Steven Bright"
date: "04/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean global environment}
remove(list = ls())
```

```{r Turn scientific notation off}
#Change it to "= 0" to turn it back on
options(scipen = 999)
```

#Call libraries

```{r Install packages}
#install.packages("broom")
#install.packages("knitr)
#install.packages("car")
#install.packages("rstatix")
#install.packages("pscl")
#install.packages("boot")
#install.packages("stats")
#install.packages("rcompanion")
#install.packages("MASS")
#install.packages("openxlsx")
#install.packages("tidyverse")
```

```{r Load libraries}
library(broom)
library(knitr)
library(car)
library(rstatix)
library(pscl)
library(boot)
library(stats)
library(rcompanion)
library(MASS)
library(openxlsx)
library(tidyverse)
```

#Read in data

```{r Source paths}
source("..//COPING_participation_paths.r")
```

```{r Source functions}
source("..//COPING_participation_functions.r")
```

```{r Read in glad coping participation data}
glad_coping_participation <- read_rds(paste0(processed_data_path, processed_data_name))

#Check data
glad_coping_participation %>% 
  head()
```

#Preliminaries
##Variables

```{r Define explanatory and outcome variables}
#Create explanatory variables vector
explanatory_variables <- c(
  "age_cleaned",
  "gender_recode_labelled",
  "highest_education_labelled",
  "ethnicity_labelled",
  "employment_labelled",
  "partnership_status_labelled",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelled",
  "physical_health_comorbidities_labelled",
  "MH_disorders_total_count",
  "depressive_and_anxiety_comorbidity_labelled",
  "eating_disorders_labelled",
  "OCRDs_labelled",
  "psychotic_and_biploar_disorder_labelled",
  "asd_labelled",
  "ADHD_ADD_labelled",
  "personality_disorder_labelled",
  #"PTSD_labelled", # Hasing this out because it turns to NA in models after adding anx/dep comorbidity
  "startDate",
  "kit_returned_labelled"
  #joined_coping_first_invitation_labelled,
)

#Create dependent variable vectors
coping_baseline_outcome <- c("completed_baseline_labelled")
coping_followups_outcome <- c("total_COPING_waves")
providing_kit_outcome <- c("kit_returned_labelled")
```

```{r Put ZINB explanatory variables into a vector}
ZINB_model1_variables <- c(
  "age_cleaned",  
    "gender_recode_labelled", 
    "highest_education_labelled",
    "ethnicity_labelled",
    "employment_labelled", 
    "partnership_status_labelled",
    "phq.sum_score",
    "gad.sum_score", 
    "audit.sum_score",
    "smoking_status_labelled",
    "physical_health_comorbidities_labelled",
    "MH_disorders_total_count",
    "depressive_and_anxiety_comorbidity_labelled",
    "eating_disorders_labelled",
    "OCRDs_labelled",
    "psychotic_and_biploar_disorder_labelled",
    "asd_labelled",
    "ADHD_ADD_labelled",
    "personality_disorder_labelled",
    #"PTSD_labelled", #Causes an error after adding anx/dep comorbidity variable
    "kit_returned_labelled"
    #"startDate" #Throws error
    )

#Explanatory variables for exploratory models 
##Exploratory model 1: Without the saliva kit variable
exploratory_ZINB_model1_variables <- ZINB_model1_variables %>% 
  str_subset(pattern = "kit_returned_labelled",
             negate = TRUE)

##Exploratory model 2: Only pt's who have provided a saliva kit
exploratory_ZINB_model2_variables <- exploratory_ZINB_model1_variables
```

##Formulas

```{r Create aim 1 model formulas}
#Main aim1 formula
aim1_baseline_participation_formula <- as.formula(paste(coping_baseline_outcome, 
                                                        paste(explanatory_variables, 
                                                              collapse=" + "), 
                                                        sep = " ~ "))

#Exploratory aim1 formulas
##Exploratory model 1: Omitting the saliva kit variable
exploratory_LR_model1_explan_vars <- explanatory_variables %>% 
  str_subset(pattern = "kit_returned_labelled",
             negate = TRUE)

exploratory_LR_model1_formula <- as.formula(paste(coping_baseline_outcome, 
                                                  paste(exploratory_LR_model1_explan_vars, 
                                                        collapse=" + "), 
                                                  sep = " ~ "))

##Exploratory model 2: Only participants who have returned a saliva kit
exploratory_LR_model2_explan_vars <- explanatory_variables %>% 
  str_subset(pattern = "kit_returned_labelled",
             negate = TRUE)

exploratory_LR_model2_formula <- as.formula(paste(coping_baseline_outcome, 
                                                  paste(exploratory_LR_model2_explan_vars, 
                                                        collapse=" + "), 
                                                  sep = " ~ "))

##Exploratory model 3: Providing a saliva kit as the outcome variable
exploratory_LR_model3_explan_vars <- explanatory_variables %>% 
  str_subset(pattern = "kit_returned_labelled",
             negate = TRUE)

exploratory_LR_model3_formula <- as.formula(paste(providing_kit_outcome, 
                                                  paste(exploratory_LR_model3_explan_vars, 
                                                        collapse=" + "), 
                                                  sep = " ~ "))
```

```{r Create aim 2 model formulas}
#Explanatory aim2 model formulas
##Explanatory model 1: Without the saliva kit variable
exploratory_ZINB_model1_exclude_vars <- c("kit_returned_labelled|startDate")

exploratory_ZINB_model1_explan_vars <- explanatory_variables %>% 
  str_subset(pattern = exploratory_ZINB_model1_exclude_vars,
             negate = TRUE)

exploratory_ZINB_model1_formula <- as.formula(paste(coping_baseline_outcome, 
                                                  paste(exploratory_ZINB_model1_explan_vars, 
                                                        collapse=" + "), 
                                                  sep = " ~ "))

##Explanatory model 2: Only pt's who returned their saliva kit
exploratory_ZINB_model2_formula <- exploratory_ZINB_model1_formula
```

##Reference groups
This is for creating tidy output from the models.

```{r Put aim1 LR model names into a vector}
aim1_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode_labelledFemale",
  "gender_recode_labelledNon-binary/prefer to self-define",
  "highest_education_labelledA levels/AS levels or equivalent",
  "highest_education_labelledO levels/GCSEs or CSEs or equivalent",
  "highest_education_labelledNVQ or HND or HNC or equivalent",
  "highest_education_labelledNone of the above",
  "ethnicity_labelledMixed",
  "ethnicity_labelledAsian or Asian British",
  "ethnicity_labelledBlack or Black British",
  "ethnicity_labelledArab",
  "ethnicity_labelledOther",
  "employment_labelledRetired",
  "employment_labelledLooking after home and/or family",
  "employment_labelledUnable to work because of sickness or disability",
  "employment_labelledUnemployed",
  "employment_labelledDoing unpaid or voluntary work",
  "employment_labelledFull or part-time_student",
  "employment_labelledNone of the above",
  "partnership_status_labelledRelationship or married/civil partnership",
  "partnership_status_labelledDivorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelledI smoke now",
  "smoking_status_labelledI used to smoke",
  "physical_health_comorbidities_labelled1 physical health disorder",
  "physical_health_comorbidities_labelled2+ physical health disorders",
  "MH_disorders_total_count",
  "depressive_and_anxiety_comorbidity_labelledNo depressive and anxiety disorder",
  "depressive_and_anxiety_comorbidity_labelledDepressive disorder only",
  "depressive_and_anxiety_comorbidity_labelledAnxiety disorder only",
  "eating_disorders_labelledEating disorder",
  "OCRDs_labelledOCRDs",
  "psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
  "psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
  "psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
  "asd_labelledAutistic spectrum disorder",
  "ADHD_ADD_labelledADHD or ADD disorder",
  "mhd.personality_disorder_labelledPersonality disorder",
  #"PTSD_labelledPost-traumatic stress disorder", # turns to NA in models after adding anx/dep comorbidity
  "startDate",
  "kit_returnedPt has provided saliva kit"
  #"joined_coping_first_invitationCompleted COPING baseline before 1st follow-up"
)
```

```{r Reference groups for exploratory models}
#Exploratory model 1: Remove the saliva kit provided variable
exploratory_LR_model1_names <- aim1_LR_model_names %>% 
  str_subset(pattern = "kit_returnedPt has provided saliva kit",
             negate = TRUE)

#Exploratory model 2: Only pt's who have provided a saliva kit
exploratory_LR_model2_names <- exploratory_LR_model1_names

#Exploratory model 3: Providing a saliva kit as the outcome variable
exploratory_LR_model3_names <- exploratory_LR_model1_names
```

##Kit providers subset

This data set contains only the participants who have returned a saliva kit 
- important for exploratory models.

```{r Filter pts who have returned a kit}
glad_coping_participation_returned_kit <- glad_coping_participation %>% 
  filter(kit_returned == 1)
```

```{r Change reference group of depression/anxiety comorbidity}
#We want the depression/anxiety comorbidity to be the reference group because it has the largest N
##Full sample
glad_coping_participation$depressive_and_anxiety_comorbidity_labelled <- relevel(glad_coping_participation$depressive_and_anxiety_comorbidity_labelled,
        ref = "Depressive and anxiety disorder")

##Pt's who have provided a kit
glad_coping_participation_returned_kit$depressive_and_anxiety_comorbidity_labelled <- relevel(glad_coping_participation_returned_kit$depressive_and_anxiety_comorbidity_labelled,
        ref = "Depressive and anxiety disorder")
```

##Adjusted p value threshold

24/07/2022
Since we are running 6 models in total, we need to adjust the p-value threshold
by 6 to adjust for multiple testing. This method was preferred to adjusting the 
actual p-values themselves by the authors.

```{r Create adjusted p-value threshold object}
#Create p-value and no. of test objects
standard_p_value_level <- 0.05
aim1_model_n_tests <- 42
aim2_model_n_tests <- 41
exploratory_ZINB_model_n_tests <- 40

#Create adjusted p value thresholds
aim1_adjusted_sig_threshold <- format.pval(pv = standard_p_value_level / aim1_model_n_tests,
                                     digits = 3)

aim2_adjusted_sig_threshold <- format.pval(pv = standard_p_value_level / aim2_model_n_tests,
                                     digits = 3)

exploratory_ZINB_adjusted_sig_threshold <- format.pval(pv = standard_p_value_level / exploratory_ZINB_model_n_tests,
                                                       digits = 3)



#Check thresholds
aim1_adjusted_sig_threshold
aim2_adjusted_sig_threshold #Exploratory LR model 1 and 2 will also use same threshold
exploratory_ZINB_adjusted_sig_threshold
```

#Aim 1 Logistic regression model

Our first aim is to see whether participation in the COPING baseline is 
explained by the sociodemographic, mental and physical health characteristics
of the GLAD Study participants.

```{r Run complete LR model}
aim1_LR_model <- glm(
  formula = aim1_baseline_participation_formula,
  family = "binomial",
  data = glad_coping_participation)

#Check output
summary(aim1_LR_model)
```

```{r Calculate nagelkerke effect size}
aim1_LR_model %>% 
  nagelkerke()
```

```{r Create tidy output for complete LR model}
#Create tidy model output
aim1_LR_model_tidy <- tidy(
  aim1_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = aim1_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  dplyr::select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    #adj.p.value = p.adjust(p.value, 
    #                       "bonferroni"),
    #adj_significance = case_when(
    #    adj.p.value <= 0.001 ~ "***",
    #    adj.p.value <= 0.01 ~ "**",
    #    adj.p.value <= 0.05 ~ "*",
    #    adj.p.value > 0.05 ~ ""
    #  ),
    OR = round(OR, 2),
    `CI 95% lower` = round(`CI 95% lower`, 2),
    `CI 95% upper` = round(`CI 95% upper`, 2),
    p.value = format.pval(pv = p.value,
                          digits = 2),
    threshold_adj_sig = case_when(
      p.value <= aim1_adjusted_sig_threshold ~ "Significant",
      p.value > aim1_adjusted_sig_threshold ~ "Not-significant"
        )
    )

#Check output
aim1_LR_model_tidy
```

##Test model assumptions

Checking LR assumptions in R: 
http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/

###Multicollinearity

Check that all IVs are not highly correlated.

```{r Get VIF values of final model}
aim1_LR_model_VIF <- aim1_LR_model %>% 
  vif()

aim1_LR_model_VIF
```

###Linearity

Check the relationship between the continuous predictor variables and the logit
of the DV. This can be inspected visually by creating scatterplots between each
predictor and the logit values.

Note: We have to remove values that have 0 because when you log transform
a variable, it throws an error if there are any 0's in the variable. See:
https://stackoverflow.com/questions/31177795/error-in-glm-in-r

```{r Remove observations that have 0 on the continuous variables}
glad_coping_participation_lin <- glad_coping_participation %>% 
  filter(gad.sum_score != 0,
         phq.sum_score != 0,
         audit.sum_score != 0)

#Check new dimensions
glad_coping_participation %>% 
  dim()

glad_coping_participation_lin %>% 
  dim()
```

```{r LR model with interaction terms for continuous variables}
linearity_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned*log(age_cleaned) +
    gad.sum_score*log(gad.sum_score) +
    phq.sum_score*log(phq.sum_score) +
    audit.sum_score*log(audit.sum_score),
  family = "binomial",
  data = glad_coping_participation_lin
)

linearity_model %>% 
  summary()
```

###Outliers

Anything > 1 is a cause for concern.

```{r Check cooks distance values in LR model}
plot(aim1_LR_model,
     which = 4)
```

```{r Extract model results}
LR.model_data <- augment(aim1_LR_model) %>% 
  mutate(index = 1:n())

#Check output
LR.model_data %>% 
  glimpse()
```

```{r Plot standardised residuals}
LR.model_data %>% 
  ggplot(aes(index, .std.resid)) +
  geom_point(aes(colour = completed_baseline_labelled), alpha = .5) +
  theme_minimal()
```

```{r Check standardised residuals > 3.3}
LR.model_data %>% 
  filter(abs(.std.resid) > 3.3)
```

##Plot LR model 1 results

```{r Extract odds ratios and CI's}
#Get OR's and CI's for explanatory variables
or_CI <- round(exp(cbind(coef(aim1_LR_model), 
                         confint(aim1_LR_model))), 
               digits=3) %>% 
  as.data.frame()

#Create variable column with variable names
or_CI <- or_CI %>% 
  mutate(variable=rownames(or_CI)) # extract the variables from rownames
  
#Rename and reorder columns
or_CI <- or_CI %>% 
  rename("AOR" = "V1",
         "lower_bound" = "2.5 %",
         "upper_bound" = "97.5 %"
         ) %>% 
  dplyr::select(
    variable,
    AOR,
    lower_bound,
    upper_bound
  )

or_CI
```

```{r Turn explanatory variable column into a factor for plot}
#Create levels vector for explanatory variable column
explanatory_variable_levels <- c(
  "(Intercept)",
  "Age",
  "Female",
  "Non-binary/prefer to self-define",
  "A levels/AS levels or equivalent",
  "GCSEs or CSEs or equivalent",
  "NVQ or HND or HNC or equivalent",
  "None of the above edu",
  "Mixed",
  "Asian or Asian British",
  "Black or Black British",
  "Arab",
  "Other",
  "Retired",
  "Looking after home and/or family",
  "Sickness or disabled",
  "Unemployed",
  "Doing unpaid or voluntary work",
  "Student",
  "None of the above employ",
  "Relationship or married",
  "Divorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "I smoke now",
  "I used to smoke",
  "1 physical health disorder",
  "2+ physical health disorders",
  "MH_disorders_total_count",
  "depressive_and_anxiety_comorbidity_labelledNo depressive and anxiety disorder",
  "depressive_and_anxiety_comorbidity_labelledDepressive disorder only",
  "depressive_and_anxiety_comorbidity_labelledAnxiety disorder only",
  "Eating disorder",
  "OCRDs",
  "Psychotic and bipolar disorder",
  "Only psychotic disorder",
  "Only bipolar disorder",
  "ASD",
  "ADHD or ADD disorder",
  "Personality disorder",
  #"PTSD", #Removing PTSD because not in models anymore
  "startDate",
  "Pt has provided saliva kit"
)

or_CI <- or_CI %>% 
  mutate(variable = explanatory_variable_levels)

or_CI$variable <- factor(or_CI$variable,
                              levels = explanatory_variable_levels)

#Check output
or_CI
```

```{r Forest plot of LR results}
plot_logit_model <- or_CI %>% 
  slice(-1) %>% #remove row number 1 (The intercept) 
  ggplot(aes(x = variable, y = AOR)) +
  geom_point(shape = 15,
             size  = 1, 
             position = "dodge", 
             color="black") + 
  geom_errorbar(aes(ymin  = lower_bound,
                    ymax  = upper_bound),
                size  = 0.7,
                position = "dodge", 
                color= "#EFC10B") +
  labs(title = "LR of participation in the COPING baseline survey",
         x = "Explanatory variables",
       y = "Adjusted odds ratios with 95% CI") +
  coord_flip() + 
  scale_y_continuous(breaks = seq(0, 4, 0.5),
                     limits = c(0, 4)) +
  scale_x_discrete(limits = rev) +
  geom_hline(yintercept = 1, color = "red", size = 1) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(colour = "black"),
         axis.ticks = element_line(color = "black"))

#Check plot
plot_logit_model
```

##Run exploratory LR models
###Without saliva kit variable

During the analysis, we began to think that it may be circular to include
a measure of participation (providing a saliva kit for the GLAD study) as 
a predictor of participation. Therefore, we want to re-run the LR model
without the saliva kit predictor to see to what extent this influences the 
results.

```{r Run exploratory LR model1}
exploratory_LR_model1 <- glm(
  formula = exploratory_LR_model1_formula,
  family = "binomial",
  data = glad_coping_participation)

#Check output
summary(exploratory_LR_model1)
```

```{r Calculate nagelkerke effect size}
exploratory_LR_model1 %>% 
  nagelkerke()
```

```{r Create tidy output for exploratory LR model1}
exploratory_LR_model1_tidy <- tidy(
  exploratory_LR_model1,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = exploratory_LR_model1_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  dplyr::select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    #adj.p.value = p.adjust(p.value, 
    #                       "bonferroni"),
    #adj_significance = case_when(
    #    adj.p.value <= 0.001 ~ "***",
    #    adj.p.value <= 0.01 ~ "**",
    #    adj.p.value <= 0.05 ~ "*",
    #    adj.p.value > 0.05 ~ ""
    #  ),
    OR = round(OR, 2),
    `CI 95% lower` = round(`CI 95% lower`, 2),
    `CI 95% upper` = round(`CI 95% upper`, 2),
    p.value = format.pval(pv = p.value,
                          digits = 2),
    threshold_adj_sig = case_when(
      p.value <= aim2_adjusted_sig_threshold ~ "Significant",
      p.value > aim2_adjusted_sig_threshold ~ "Not-significant"
        )
    )

#Check output
exploratory_LR_model1_tidy
```

###Only pt's who have provided a saliva kit
17/07/2022
After presenting the first draft of the paper to the GLAD analysis team,
Prof. Gerome Breen suggested that instead of omitting the saliva kit variable,
it would be better to run the LR model whilst only including the participants 
who have provided a saliva kit.

```{r Investigate factors associated with COPING baseline participation for kit returners}
exploratory_LR_model2 <- glm(
  formula = exploratory_LR_model2_formula,
  family = "binomial",
  data = glad_coping_participation_returned_kit)

#Check output
summary(exploratory_LR_model2)
```

```{r Calculate nagelkerke effect size}
exploratory_LR_model2 %>% 
  nagelkerke()
```

```{r Create tidy output for providing a kit LR model}
exploratory_LR_model2_tidy <- tidy(
  exploratory_LR_model2,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = exploratory_LR_model2_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  dplyr::select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    #adj.p.value = p.adjust(p.value, 
    #                       "bonferroni"),
    #adj_significance = case_when(
    #    adj.p.value <= 0.001 ~ "***",
    #    adj.p.value <= 0.01 ~ "**",
    #    adj.p.value <= 0.05 ~ "*",
    #    adj.p.value > 0.05 ~ ""
    #),
    OR = round(OR, 2),
    `CI 95% lower` = round(`CI 95% lower`, 2),
    `CI 95% upper` = round(`CI 95% upper`, 2),
    p.value = format.pval(pv = p.value,
                          digits = 2),
    threshold_adj_sig = case_when(
      p.value <= aim2_adjusted_sig_threshold ~ "Significant",
      p.value > aim2_adjusted_sig_threshold ~ "Not-significant"
        )
    )

#Check output
exploratory_LR_model2_tidy
```

###Providing kit as outcome
17/07/2022
After presenting the first draft of the paper to the GLAD analaysis team,
it was recommended that a model could be run to investigate what factors 
are associated with providing a saliva kit to the GLAD Study.

```{r Run LR model to invesitgate factors associated with providing a kit}
exploratory_LR_model3 <- glm(
  formula = exploratory_LR_model3_formula,
  family = "binomial",
  data = glad_coping_participation)

#Check output
summary(exploratory_LR_model3)
```

```{r Calculate nagelkerke effect size}
exploratory_LR_model3 %>% 
  nagelkerke()
```

```{r Create tidy output for providing a kit LR model}
#Create tidy model output
exploratory_LR_model3_tidy <- tidy(
  exploratory_LR_model3,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = exploratory_LR_model3_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  dplyr::select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    #adj.p.value = p.adjust(p.value, 
    #                       "bonferroni"),
    #adj_significance = case_when(
    #    adj.p.value <= 0.001 ~ "***",
    #    adj.p.value <= 0.01 ~ "**",
    #    adj.p.value <= 0.05 ~ "*",
    #    adj.p.value > 0.05 ~ ""
    #  ),
    OR = round(OR, 2),
    `CI 95% lower` = round(`CI 95% lower`, 2),
    `CI 95% upper` = round(`CI 95% upper`, 2),
    p.value = format.pval(pv = p.value,
                          digits = 2),
    threshold_adj_sig = case_when(
      p.value <= aim2_adjusted_sig_threshold ~ "Significant",
      p.value > aim2_adjusted_sig_threshold ~ "Not-significant"
        )
    )

#Check output
exploratory_LR_model3_tidy
```

#Aim 2: Zero-inflated negative binomial regression

For aim 2, we want to see which variables are associated with participating
in the COPING follow-up surveys. We will run a zero-inflated negative binomial
regression to test for this.

```{r Run ZINB model}
ZINB_model1 <- zeroinf.neg.binomial.estimates(
  outcome = coping_followups_outcome,
  explanatory_variables = ZINB_model1_variables,
  data_set = "glad_coping_participation",
  name = "ZINB_model1"
)

#Check ZINB model output
ZINB_model1
```

```{r Create a significance column for the ZINB model results}
#Rename p value column
ZINB_model1 <- ZINB_model1 %>% 
  rename("p_value" = "p value")

#Turn p value column to numeric type instead of character
ZINB_model1$p_value <- as.numeric(ZINB_model1$p_value)

#Create column to show whether variable meets adjusted p value threshold
ZINB_model1 <- ZINB_model1 %>% 
  mutate(
    p_value = format.pval(p_value,
                          digits = 2),
    threshold_adj_sig = case_when(
        p_value <= aim2_adjusted_sig_threshold ~ "Significant",
        p_value > aim2_adjusted_sig_threshold ~ "Not-significant"
      )
  )

#Check significance column
ZINB_model1
```

##Plot ZINB model 1

```{r Extract odds ratios and CI's from ZINB model}
#Get OR's and CI's for explanatory variables
ZINB_model_or_CI <- ZINB_model1 %>% 
  filter(
    Part == "zero"
  ) %>% 
  dplyr::select(
    "Independent_variable" = "Independent variable",
    Estimate,
    CI_95_low = "95% CI low",
    CI_95_up = "95% CI up"
  )

ZINB_model_or_CI
```

```{r Turn independent variable column into a factor for plot}
#Create levels vector for explanatory variable column
ZINB_model1_explanatory_variable_levels <- c(
  "(Intercept)",
  "Age",
  "Female",
  "Non-binary/prefer to self-define",
  "A levels/AS levels or equivalent",
  "GCSEs or CSEs or equivalent",
  "NVQ or HND or HNC or equivalent",
  "None of the above edu",
  "Mixed",
  "Asian or Asian British",
  "Black or Black British",
  "Arab",
  "Other",
  "Retired",
  "Looking after home and/or family",
  "Sickness or disabled",
  "Unemployed",
  "Doing unpaid or voluntary work",
  "Student",
  "None of the above employ",
  "Relationship or married",
  "Divorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "I smoke now",
  "I used to smoke",
  "1 physical health disorder",
  "2+ physical health disorders",
  "MH_disorders_total_count",
  "depressive_and_anxiety_comorbidity_labelledNo depressive and anxiety disorder",
  "depressive_and_anxiety_comorbidity_labelledDepressive disorder only",
  "depressive_and_anxiety_comorbidity_labelledAnxiety disorder only",
  "Eating disorder",
  "OCRDs",
  "Psychotic and bipolar disorder",
  "Only psychotic disorder",
  "Only bipolar disorder",
  "ASD",
  "ADHD or ADD disorder",
  "Personality disorder",
  #"PTSD", #PTSD is no longer in the models
  "Pt has provided saliva kit"
)

ZINB_model_or_CI <- ZINB_model_or_CI %>% 
  mutate(Independent_variable = ZINB_model1_explanatory_variable_levels)

ZINB_model_or_CI$Independent_variable <- factor(ZINB_model_or_CI$Independent_variable,
                              levels = ZINB_model1_explanatory_variable_levels)

#Check output
ZINB_model_or_CI
```

```{r Forest plot of ZINB results}
ZINB_model_or_CI %>% 
  slice(-1) %>% #remove row number 1 (The intercept) 
  ggplot(aes(x = Independent_variable, y = Estimate)) +
  geom_point(shape = 15,
             size = 1, 
             #position = position_dodge(width = NULL), 
             color = "black") + 
  geom_errorbar(aes(ymin = CI_95_low,
                    ymax = CI_95_up),
                size = 0.7,
                #position = position_dodge(width = NULL), 
                color = "#EFC10B") +
  labs(title = "ZINB model of follow-up surveys",
         x = "Explanatory variables",
       y = "Adjusted rate ratios with 95% CI") +
  coord_flip() + 
  scale_y_continuous(breaks = seq(0, 4.5, 0.5),
                     limits = c(0, 4.5)) +
  scale_x_discrete(limits = rev) +
  geom_hline(yintercept = 1, color = "red", size = 1) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(colour = "black"),
         axis.ticks = element_line(color = "black"))
```

### OLD: Adjusting for multiple testing
17/07/2022
This was old code for adjusting for multiple testing. However, Prof. Gerome 
Breen has recommended using a p-value threshold rather than adjusting the 
p-values themselves.

```{r Get p-values of ZINB model}
#ZINB_model_p_values <- parameters::p_value(ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
#ZINB_model_p_values <- ZINB_model_p_values %>% 
#  select(Parameter, p) %>% 
#  filter(str_detect(Parameter, "zero_"))

#Check results
#ZINB_model_p_values
```

```{r Adjust the ZINB model p-values for multiple testing}
#adj_ZINB_p_values <- ZINB_model_p_values$p %>% 
#  p.adjust("bonferroni")

#Add the adjusted p-values to the p-value model
#ZINB_model_p_values <- cbind(ZINB_model_p_values,
#                             adj_ZINB_p_values)

#Create a significant label variable based on the adjusted p-values
#ZINB_model_p_values <- ZINB_model_p_values %>% 
#  mutate(
#    adj_significance = case_when(
#        adj_ZINB_p_values <= 0.001 ~ "***",
#        adj_ZINB_p_values <= 0.01 ~ "**",
#        adj_ZINB_p_values <= 0.05 ~ "*",
#        adj_ZINB_p_values > 0.05 ~ ""
#      )
#  ) %>% 
#  select(
#    Parameter,
#    adj_significance,
#    p,
#    adj_ZINB_p_values
#  )

#Check results
#ZINB_model_p_values
```

```{r Get p-values of count part of ZINB model}
#ZINB_model_count_p_values <- parameters::p_value(ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
#ZINB_model_count_p_values <- ZINB_model_count_p_values %>% 
#  select(Parameter, p) %>% 
#  filter(str_detect(Parameter, "count_"))

#Check results
#ZINB_model_count_p_values
```

```{r Adjust the ZINB model count p-values for multiple testing}
#adj_ZINB_count_p_values <- ZINB_model_count_p_values$p %>% 
#  p.adjust("bonferroni")

#Add the adjusted p-values to the p-value model
#ZINB_model_count_p_values <- cbind(ZINB_model_count_p_values,
#                             adj_ZINB_count_p_values)

#Create a significant label variable based on the adjusted p-values
#ZINB_model_count_p_values <- ZINB_model_count_p_values %>% 
#  mutate(
#    adj_significance = case_when(
#        adj_ZINB_p_values <= 0.001 ~ "***",
#        adj_ZINB_p_values <= 0.01 ~ "**",
#        adj_ZINB_p_values <= 0.05 ~ "*",
#        adj_ZINB_p_values > 0.05 ~ ""
#      )
#  ) %>% 
#  select(
#    Parameter,
#    adj_significance,
#    p,
#    adj_ZINB_count_p_values
#  )

#Check results
#ZINB_model_count_p_values
```

##Exploratory ZINB models
###Without providing kit variable
In the same sense of the exploratory LR model, we want to run an exploratory
ZINB model without the providing a saliva kit variable to see if this influences
the results.

```{r Run exploratory ZINB model without saliva kit variable}
exploratory_ZINB_model1 <- zeroinf.neg.binomial.estimates(
  outcome = coping_followups_outcome,
  explanatory_variables = exploratory_ZINB_model1_variables,
  data_set = "glad_coping_participation",
  name = "exploratory_ZINB_model1"
)

#Check ZINB model output
exploratory_ZINB_model1 %>% 
  head()
```

```{r Create a significance column for the exploratory ZINB model 1 results}
#Rename p value column
exploratory_ZINB_model1 <- exploratory_ZINB_model1 %>% 
  rename("p_value" = "p value")

#Turn p value column to numeric type instead of character
exploratory_ZINB_model1$p_value <- as.numeric(exploratory_ZINB_model1$p_value)

#Create column to show whether factor meets adjusted p value threshold
exploratory_ZINB_model1 <- exploratory_ZINB_model1 %>% 
  mutate(
    p_value = format.pval(p_value,
                          digits = 2),
    threshold_adj_sig = case_when(
        p_value <= exploratory_ZINB_adjusted_sig_threshold ~ "Significant",
        p_value > exploratory_ZINB_adjusted_sig_threshold ~ "Not-significant"
      )
  )

#Check significance column
exploratory_ZINB_model1 %>% 
  head()
```

###OLD: Adjusting for multiple testing

```{r Get p-values of exploratory ZINB model}
#exploratory_ZINB_model_p_values <- parameters::p_value(exploratory_ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
#exploratory_ZINB_model_p_values <- exploratory_ZINB_model_p_values %>% 
#  select(Parameter, p) %>% 
#  filter(str_detect(Parameter, "zero_"))

#Check results
#exploratory_ZINB_model_p_values
```

```{r Adjust the exploratory ZINB model p-values for multiple testing}
#adj_exploratory_ZINB_p_values <- exploratory_ZINB_model_p_values$p %>% 
#  p.adjust("bonferroni")

#Add the adjusted p-values to the p-value model
#exploratory_ZINB_model_p_values <- cbind(exploratory_ZINB_model_p_values,
#                                         adj_exploratory_ZINB_p_values)

#Create a significant label variable based on the adjusted p-values
#exploratory_ZINB_model_p_values <- exploratory_ZINB_model_p_values %>% 
#  mutate(
#    adj_significance = case_when(
#        adj_exploratory_ZINB_p_values <= 0.001 ~ "***",
#        adj_exploratory_ZINB_p_values <= 0.01 ~ "**",
#        adj_exploratory_ZINB_p_values <= 0.05 ~ "*",
#        adj_exploratory_ZINB_p_values > 0.05 ~ ""
#      )
#  ) %>% 
#  select(
#    Parameter,
#    adj_significance,
#    p,
#    adj_exploratory_ZINB_p_values
#  )

#Check results
#exploratory_ZINB_model_p_values
```

```{r Get count p-values of exploratory ZINB model}
#exploratory_ZINB_model_count_p_values <- parameters::p_value(exploratory_ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
#exploratory_ZINB_model_count_p_values <- exploratory_ZINB_model_count_p_values %>% 
#  select(Parameter, p) %>% 
#  filter(str_detect(Parameter, "count_"))

#Check results
#exploratory_ZINB_model_count_p_values
```

```{r Adjust the exploratory ZINB model p-values for multiple testing}
#adj_exploratory_ZINB_count_p_values <- exploratory_ZINB_model_count_p_values$p %>% 
#  p.adjust("bonferroni")

#Add the adjusted p-values to the p-value model
#exploratory_ZINB_model_count_p_values <- cbind(exploratory_ZINB_model_count_p_values,
#                                         adj_exploratory_ZINB_count_p_values)

#Create a significant label variable based on the adjusted p-values
#exploratory_ZINB_model_count_p_values <- exploratory_ZINB_model_count_p_values %>% 
#  mutate(
#    adj_significance = case_when(
#        adj_exploratory_ZINB_count_p_values <= 0.001 ~ "***",
#        adj_exploratory_ZINB_count_p_values <= 0.01 ~ "**",
#        adj_exploratory_ZINB_count_p_values <= 0.05 ~ "*",
#        adj_exploratory_ZINB_count_p_values > 0.05 ~ ""
#      )
#  ) %>% 
#  select(
#    Parameter,
#    adj_significance,
#    p,
#    adj_exploratory_ZINB_count_p_values
#  )

#Check results
#exploratory_ZINB_model_count_p_values
```

###Kit returners only
17/07/2022
After presenting the first draft of the paper to the GLAD analysis team,
Prof. Gerome Breen suggested that instead of omitting the saliva kit variable,
it would be better to run the ZINB model whilst only including the participants 
who have provided a saliva kit.

```{r Run exploratory ZINB model 2}
exploratory_ZINB_model2 <- zeroinf.neg.binomial.estimates(
  outcome = coping_followups_outcome,
  explanatory_variables = exploratory_ZINB_model2_variables,
  data_set = "glad_coping_participation_returned_kit",
  name = "exploratory_ZINB_model2"
)

#Check ZINB model output
exploratory_ZINB_model2 %>% 
  head()
```

```{r Create a significance column for the exploratory ZINB model 1 results}
#Rename p value column
exploratory_ZINB_model2 <- exploratory_ZINB_model2 %>% 
  rename("p_value" = "p value")

#Turn p value column to numeric type instead of character
exploratory_ZINB_model2$p_value <- as.numeric(exploratory_ZINB_model2$p_value)

#Create column to show whether factor meets adjusted p value threshold
exploratory_ZINB_model2 <- exploratory_ZINB_model2 %>% 
  mutate(
    p_value = format.pval(p_value,
                          digits = 2),
    threshold_adj_sig = case_when(
        p_value <= exploratory_ZINB_adjusted_sig_threshold ~ "Significant",
        p_value > exploratory_ZINB_adjusted_sig_threshold ~ "Not-significant"
      )
  )

#Check significance column
exploratory_ZINB_model2 %>% 
  head()
```

# Paper revisions
23/03/2023

After submitting the manuscript to BMC Psychiatry, we received some revisions to make during the peer review. Notably, two comments about the analysis included:

1) Considering using a Poisson/negative binomial regression over a ZINB model.
2) Using a Box-Tidwell test to assess whether the continuous variables in the LR model are linearly related to the logit transformation of the DV.

These points will each be addressed in turn.

## Revision 1: Using poisson or negative binomial regression over ZINB model

The reviewer's rationale for suggesting these alternative models is that the ZINB model is highly sensitive to outliers. However, we chose to utilise the ZINB model because there is an excess of 0's in the outcome variable of COPING follow-up survey completion. That is, many participants who completed the COPING baseline survey did not complete any COPING follow-up surveys. The ZINB model, unlike these alternative models, is designed to handle these excess 0's.

Therefore, we will check whether there are any outliers for the continuous variables within our data.

```{r Select continuous variables used in ZINB model}
# Create vector of continuous variables used in ZINB model
continuous_vars <- c(
  "age_cleaned",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "MH_disorders_total_count"
)

# Select continuous variables
continuous_vars_subset <- glad_coping_participation %>% 
  select(all_of(continuous_vars))

# Check
continuous_vars_subset %>% 
  head()
```

```{r Check for outliers in age}
age_boxplot <- continuous_vars_subset %>% 
  ggplot(aes(y = age_cleaned)) +
  geom_boxplot(colour = "Black", fill = "#EFC10B") +
  theme_minimal() +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  labs(y = "Age") +
  scale_y_continuous(breaks = seq(0, 100, by = 10))

age_boxplot

# Save plot
ggsave("../age_boxplot.jpeg",
       plot = age_boxplot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Check for outliers in PHQ depression scores}
phq_boxplot <- continuous_vars_subset %>% 
  ggplot(aes(y = phq.sum_score)) +
  geom_boxplot(colour = "Black", fill = "#EFC10B") +
  theme_minimal() +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  labs(y = "PHQ sum score") +
  scale_y_continuous(breaks = seq(0, 27, by = 3))

phq_boxplot

# Save plot
ggsave("../phq_boxplot.jpeg",
       plot = phq_boxplot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Check for outliers in GAD anxiety scores}
gad_boxplot <- continuous_vars_subset %>% 
  ggplot(aes(y = gad.sum_score)) +
  geom_boxplot(colour = "Black", fill = "#EFC10B") +
  theme_minimal() +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  labs(y = "GAD sum score") +
  scale_y_continuous(breaks = seq(0, 21, by = 3))

gad_boxplot

# Save plot
ggsave("../gad_boxplot.jpeg",
       plot = gad_boxplot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Check for outliers in GAD anxiety scores}
audit_boxplot <- continuous_vars_subset %>% 
  ggplot(aes(y = audit.sum_score)) +
  geom_boxplot(colour = "Black", fill = "#EFC10B") +
  theme_minimal() +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  labs(y = "AUDIT sum score") +
  scale_y_continuous(breaks = seq(0, 40, by = 5))

audit_boxplot

# Save plot
ggsave("../audit_boxplot.jpeg",
       plot = audit_boxplot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Check for outliers in total MH disorders count}
MH_disorder_count_boxplot <- continuous_vars_subset %>% 
  na.omit(MH_disorders_total_count) %>% # Remove cases with NAs
  ggplot(aes(y = MH_disorders_total_count)) +
  geom_boxplot(colour = "Black", fill = "#EFC10B") +
  theme_minimal() +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black")) +
  labs(y = "No. mental health disorders") +
  scale_y_continuous(breaks = seq(0, 10, by = 1))

MH_disorder_count_boxplot

# Save plot
ggsave("../MH_disorder_count_boxplot.jpeg",
       plot = MH_disorder_count_boxplot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

## Revision 2: Box-Tidwell test

Box-Tidwell tests will be performed to assess whether the continuous variables in the data are linearly related to the logit transformation of the outcome variable for our LR model. This outcome variable is whether the GLAD participants completed the COPING baseline survey or not.

```{r Create a complete case dataset}
# Create complete case dataset
glad_coping_participation_complete_case <- glad_coping_participation %>% 
  select(all_of(explanatory_variables)) %>% 
  na.omit()

# Check
glad_coping_participation_complete_case %>% 
  dim()
```

Since the Box-Tidwell function doesn't work with variables that have negative numbers or 0, we can increment the values of the continuous variables with 0's by 1 to perform the analyses.

```{r Increment continuous variables values with 0's by 1 for Box-Tidwell test}
# Increment sum score variables and total MH disorders by 1
data_for_BoxTidwell <- glad_coping_participation_complete_case %>% 
  mutate(across(continuous_vars[-1],
                ~ .x + 1)
  )

# Check
data_for_BoxTidwell %>% 
  select(all_of(continuous_vars[-1])) %>% 
  map(~ data_for_BoxTidwell %>% 
        count({{ .x }}))
```

```{r Perform Box-Tidwell tests}
# Save the logodds of the outcome variable
logodds <- aim1_LR_model$linear.predictors

# Perform Box-Tidwell tests
boxTidwell(logodds ~ age_cleaned,
           data = data_for_BoxTidwell)

boxTidwell(logodds ~ phq.sum_score,
           data = data_for_BoxTidwell)

boxTidwell(logodds ~ gad.sum_score,
           data = data_for_BoxTidwell)

boxTidwell(logodds ~ audit.sum_score,
           data = data_for_BoxTidwell)

boxTidwell(logodds ~ MH_disorders_total_count,
           data = data_for_BoxTidwell)
```

```{r Plot age and the logit transformation of the outcome}
logit_age_plot <- glad_coping_participation_complete_case %>% 
  ggplot(aes(x = age_cleaned, y = logodds)) +
  geom_point(colour = "Black") +
  theme_minimal() +
  labs(x = "Age") +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))

logit_age_plot

# Save plot
ggsave("../logit_age_plot.jpeg",
       plot = logit_age_plot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Plot PHQ and logit transformation of outcome}
logit_phq_plot <- glad_coping_participation_complete_case %>% 
  ggplot(aes(x = phq.sum_score, y = logodds)) +
  geom_point(colour = "Black") +
  theme_minimal() +
  labs(x = "PHQ sum score") +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))

logit_phq_plot

# Save
ggsave("../logit_phq_plot.jpeg",
       plot = logit_phq_plot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Plot GAD and logit transformation of outcome}
logit_gad_plot <- glad_coping_participation_complete_case %>% 
  ggplot(aes(x = gad.sum_score, y = logodds)) +
  geom_point(colour = "Black") +
  theme_minimal() +
  labs(x = "GAD sum score") +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))

logit_gad_plot

# Check
ggsave("../logit_gad_plot.jpeg",
       plot = logit_gad_plot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Plot AUDIT and logit transformation of outcome}
logit_audit_plot <- glad_coping_participation_complete_case %>% 
  ggplot(aes(x = audit.sum_score, y = logodds)) +
  geom_point(colour = "Black") +
  theme_minimal() +
  labs(x = "AUDIT sum score") +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))

logit_audit_plot

# Save
ggsave("../logit_audit_plot.jpeg",
       plot = logit_audit_plot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

```{r Plot total MH disorders and logit transformation of outcome}
logit_MH_disorder_count_plot <- glad_coping_participation_complete_case %>% 
  ggplot(aes(x = MH_disorders_total_count, y = logodds)) +
  geom_point(colour = "Black") +
  theme_minimal() +
  labs(x = "No. Mental health disorders") +
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))

logit_MH_disorder_count_plot

# Save
ggsave("../logit_MH_disorder_count_plot.jpeg",
       plot = logit_MH_disorder_count_plot,
       width = 10,
       height = 6,
       dpi = 150,
       units = "in")
```

### Sensitivity analysis: Aim 1 LR with newly categorised variables

Since 4/5 of the continuous variables were not linearly related to the outcome variable in aim 1, this sensitivity analysis will investigate whether categorising the variables markedly changes the original results. The variables to be categorised are:

- PHQ sum score
- GAD sum score
- AUDIT sum score
- Total MH disorders

#### Categorise the non-linear continuous variables

Cut-offs for the standardised scales:

PHQ9:
None (0-4)
Mild (5-9)
Moderate (10-14)
Moderately severe (15-19)
Severe (20+)

```{r Categorise the PHQ sum score variable}
glad_coping_participation <- glad_coping_participation %>% 
  mutate(PHQ_factor = 
           case_when(
             phq.sum_score >= 0 & phq.sum_score <= 4 ~ 1,
             phq.sum_score > 4 & phq.sum_score <= 9 ~ 2,
             phq.sum_score > 9 & phq.sum_score <= 14 ~ 3,
             phq.sum_score > 14 & phq.sum_score <= 19 ~ 4,
             phq.sum_score > 19 ~ 5
           ))

# Turn new variable into factor
glad_coping_participation$PHQ_factor <- factor(glad_coping_participation$PHQ_factor,
                                               levels = c(1, 2, 3, 4, 5),
                                               labels = c(
                                                 "None",
                                                 "Mild",
                                                 "Moderate",
                                                 "Moderately severe",
                                                 "Severe"
                                               ))

# Check
glad_coping_participation %>% 
  select(phq.sum_score,
         PHQ_factor) %>% 
  head()

glad_coping_participation %>% 
  count(PHQ_factor)
```

GAD7:
None (0-4)
Mild (5-9)
Moderate (10-14)
Severe (15+)

```{r Categorise the GAD sum score variable}
glad_coping_participation <- glad_coping_participation %>% 
  mutate(GAD_factor = 
           case_when(
             gad.sum_score >= 0 & gad.sum_score <= 4 ~ 1,
             gad.sum_score > 4 & gad.sum_score <= 9 ~ 2,
             gad.sum_score > 9 & gad.sum_score <= 14 ~ 3,
             gad.sum_score > 14 ~ 4
           ))

# Turn new variable into factor
glad_coping_participation$GAD_factor <- factor(glad_coping_participation$GAD_factor,
                                               levels = c(1, 2, 3, 4),
                                               labels = c(
                                                 "None",
                                                 "Mild",
                                                 "Moderate",
                                                 "Severe"
                                               ))

# Check
glad_coping_participation %>% 
  select(gad.sum_score,
         GAD_factor) %>% 
  head()

glad_coping_participation %>% 
  count(GAD_factor)
```

AUDIT:
No risk (0-7)
Increasing risk (8-15)
Higher risk (16-19)
Possible dependence (20+)

```{r Categorise the AUDIT sum score variable}
glad_coping_participation <- glad_coping_participation %>% 
  mutate(AUDIT_factor = 
           case_when(
             audit.sum_score >= 0 & audit.sum_score <= 7 ~ 1,
             audit.sum_score > 7 & audit.sum_score <= 15 ~ 2,
             audit.sum_score > 15 & audit.sum_score <= 19 ~ 3,
             audit.sum_score > 19 ~ 4
           ))

# Turn new variable into factor
glad_coping_participation$AUDIT_factor <- factor(glad_coping_participation$AUDIT_factor,
                                               levels = c(1, 2, 3, 4),
                                               labels = c(
                                                 "No risk",
                                                 "Increasing risk",
                                                 "Higher risk",
                                                 "Possible dependence"
                                               ))

# Check
glad_coping_participation %>% 
  select(audit.sum_score,
         AUDIT_factor) %>% 
  head()

glad_coping_participation %>% 
  count(AUDIT_factor)
```

```{r Categorise the total MH disorders variable}
glad_coping_participation <- glad_coping_participation %>% 
  mutate(total_MH_disorders_factor = 
           case_when(
             MH_disorders_total_count == 0 ~ 1,
             MH_disorders_total_count == 1 ~ 2,
             MH_disorders_total_count > 1 ~ 3
           ))

# Turn new variable into factor
glad_coping_participation$total_MH_disorders_factor <- factor(glad_coping_participation$total_MH_disorders_factor,
                                               levels = c(1, 2, 3),
                                               labels = c(
                                                 "No MH disorders",
                                                 "1 MH disorder",
                                                 "2+ MH disorders"
                                               ))

# Check
glad_coping_participation %>% 
  select(total_MH_disorders_factor,
         MH_disorders_total_count) %>% 
  head()

glad_coping_participation %>% 
  count(total_MH_disorders_factor)

# Note: NA's are the same as in the MH_disorders_total_count variable
glad_coping_participation %>% 
  count(MH_disorders_total_count)
```

#### Prepare model fitting

```{r Define explanatory and outcome variables}
#Create explanatory variables vector
explanatory_variables <- c(
  "age_cleaned",
  "gender_recode_labelled",
  "highest_education_labelled",
  "ethnicity_labelled",
  "employment_labelled",
  "partnership_status_labelled",
  "PHQ_factor", # new PHQ factor variable
  "GAD_factor", # New GAD factor variable
  "AUDIT_factor", # New AUDIT factor variable
  "smoking_status_labelled",
  "physical_health_comorbidities_labelled",
  "total_MH_disorders_factor", # New MH disorder count factor variable
  "depressive_and_anxiety_comorbidity_labelled",
  "eating_disorders_labelled",
  "OCRDs_labelled",
  "psychotic_and_biploar_disorder_labelled",
  "asd_labelled",
  "ADHD_ADD_labelled",
  "personality_disorder_labelled",
  #"PTSD_labelled", # Hasing this out because it turns to NA in models after adding anx/dep comorbidity
  "startDate",
  "kit_returned_labelled"
  #joined_coping_first_invitation_labelled,
)

#Create dependent variable vectors
coping_baseline_outcome <- c("completed_baseline_labelled")
```

```{r Create vector of variable terms in sensitivity analysis model}
sensitivity_analysis_model_vars <- c(
"Intercept",
"age_cleaned",
"gender_recode_labelledFemale",
"gender_recode_labelledNon-binary/prefer to self-define",
"highest_education_labelledA levels/AS levels or equivalent",
"highest_education_labelledO levels/GCSEs or CSEs or equivalent",
"highest_education_labelledNVQ or HND or HNC or equivalent",
"highest_education_labelledNone of the above",
"ethnicity_labelledMixed",
"ethnicity_labelledAsian or Asian British",
"ethnicity_labelledBlack or Black British",
"ethnicity_labelledArab",
"ethnicity_labelledOther",
"employment_labelledRetired",
"employment_labelledLooking after home and/or family",
"employment_labelledUnable to work because of sickness or disability",
"employment_labelledUnemployed",
"employment_labelledDoing unpaid or voluntary work",
"employment_labelledFull or part-time student",
"employment_labelledNone of the above",
"partnership_status_labelledRelationship or married/civil partnership",
"partnership_status_labelledDivorced/widowed/separated",
"PHQ_factorNone",
"PHQ_factorModerate",
"PHQ_factorModerately severe",
"PHQ_factorSevere",
"GAD_factorNone",
"GAD_factorModerate",
"GAD_factorSevere",
"AUDIT_factorIncreasing risk",
"AUDIT_factorHigher risk",
"AUDIT_factorPossible dependence",
"smoking_status_labelledI smoke now",
"smoking_status_labelledI used to smoke",
"physical_health_comorbidities_labelled1 physical health disorder",
"physical_health_comorbidities_labelled2+ physical health disorders",
"total_MH_disorders_factorNo MH disorders",
"total_MH_disorders_factor1 MH disorder",
"depressive_and_anxiety_comorbidity_labelled No depressive or anxiety disorder",
"depressive_and_anxiety_comorbidity_labelledDepressive disorder only",
"depressive_and_anxiety_comorbidity_labelledAnxiety disorder only",
"eating_disorders_labelledEating disorder",
"OCRDs_labelledOCRDs",
"psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
"psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
"psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
"asd_labelledAutistic spectrum disorder",
"ADHD_ADD_labelledADHD or ADD disorder",
"personality_disorder_labelledPersonality disorder",
"startDate",
"kit_returned_labelledPt has provided saliva kit"
)
```

```{r Create model formula}
sensitivity_analysis_formula <- as.formula(paste(coping_baseline_outcome, 
                                                        paste(explanatory_variables, 
                                                              collapse=" + "), 
                                                        sep = " ~ "))

# Check
sensitivity_analysis_formula
```

For the newly categorised factors, the level with the highest N pt's should be the reference group.

Note: No risk is the first level in the AUDIT variable and also has the highest N. Therefore, no need to re-level this variable.

```{r Change reference groups}
# PHQ
glad_coping_participation$PHQ_factor <- relevel(glad_coping_participation$PHQ_factor,
        ref = "Mild")

# GAD
glad_coping_participation$GAD_factor <- relevel(glad_coping_participation$GAD_factor,
        ref = "Mild")

# Total MH disorders
glad_coping_participation$total_MH_disorders_factor <- relevel(glad_coping_participation$total_MH_disorders_factor,
        ref = "2+ MH disorders")
```

```{r Create adjusted p-value threshold object}
#Create p-value and no. of test objects
standard_p_value_level <- 0.05
sensitivity_analysis_n_tests <- 50 # Factor variables has led to more tests!

#Create adjusted p value thresholds
sensitivity_analysis_adjusted_sig <- format.pval(pv = standard_p_value_level / sensitivity_analysis_n_tests,
                                     digits = 3)

#Check thresholds
sensitivity_analysis_adjusted_sig
```

#### Perform sensitivity analysis LR model

```{r Run complete LR model}
sensitivity_analysis_LR_model <- glm(
  formula = sensitivity_analysis_formula,
  family = "binomial",
  data = glad_coping_participation)

#Check output
summary(sensitivity_analysis_LR_model)
```

```{r Create tidy output for sensitivity analysis LR model}
#Create tidy model output
sensitivity_analysis_LR_model_tidy <- tidy(
  sensitivity_analysis_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = sensitivity_analysis_model_vars, # Change names here!
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  dplyr::select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    OR = round(OR, 2),
    `CI 95% lower` = round(`CI 95% lower`, 2),
    `CI 95% upper` = round(`CI 95% upper`, 2),
    p.value = format.pval(pv = p.value,
                          digits = 2),
    threshold_adj_sig = case_when(
      p.value <= sensitivity_analysis_adjusted_sig ~ "Significant",
      p.value > sensitivity_analysis_adjusted_sig ~ "Not-significant"
        )
    )

#Check output
sensitivity_analysis_LR_model_tidy
```

# Write all model output to Excel file

Note: The 1st explanatory LR and ZINB models involve removing the returned saliva kit
variable as an IV from the models. They are hashed here when the supplementary
file is being created because instead of dropping the variable, we re-ran the 
original aim 1 and 2 models by only including the participants who had returned 
a kit.

```{r Write all models to a single Excel file}
#Put models into named list
model_list <- list(
  "Aim1_LR_model" = aim1_LR_model_tidy,
  #"Exploratory_LR_model1" = exploratory_LR_model1_tidy,
  "Exploratory_LR_model1" = exploratory_LR_model2_tidy,
  "Exploratory_LR_model2" = exploratory_LR_model3_tidy,
  "Sensitivity_analysis_LR_model" = sensitivity_analysis_LR_model_tidy,
  "Aim2_ZINB_model1" = ZINB_model1,
  #"Exploratory_ZINB_model1" = exploratory_ZINB_model1,
  "Exploratory_ZINB_model1" = exploratory_ZINB_model2
)

#Write models to excel
model_list %>% 
  write.xlsx(file = "../COPING_participation_models.xlsx")
```

---
title: "COPING_participation_analysis"
author: "Steven Bright"
date: "04/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean global environment}

remove(list = ls())

```

```{r Turn scientific notation off}

#Change it to "= 0" to turn it back on
options(scipen = 999)

```

#Call libraries

```{r Install packages}

#install.packages("broom")
#install.packages("knitr)
#install.packages("car")
#install.packages("rstatix")
#install.packages("pscl")
#install.packages("stargazer")
#install.packages("boot")
#install.packages("stats")
#install.packages("tidyverse")

```

```{r Load libraries}

library(broom)
library(knitr)
library(car)
library(rstatix)
library(pscl)
library(stargazer)
library(boot)
library(stats)
library(tidyverse)

```

#Read in data

```{r Source paths}

source("..//COPING_participation_paths.r")

```

```{r Read in glad coping participation data}

glad_coping_participation_raw <- read_rds(paste0(processed_data_path, processed_data_name))

#Check data
glad_coping_participation_raw %>% 
  head()

```

#Create tables for chi2 tests

Sociodemographic variables:

Age (age groups)
Gender
Ethnicity
Education
Employment
Partnership status

```{r Run chi2 test for gender and participation in the COPING baseline}

#NOTE: Topher suggests running chi2 tests like this.

# gender_recode_baseline_participation_chi2_test <- glad_coping_participation_raw %>%
#   count(gender_recode, completed_baseline) %>%
#   spread(key = completed_baseline, value = n) %>%
#   select(-gender_recode) %>% 
#   chisq.test() %>%
#   glance() %>%
#   add_column(
#     Variable = "gender_recode", # Change variable name here -> use nice label
#     .before = 1)

```

```{r Run pairwise chi2 tests for gender and participation in the COPING baseline}

# pairwise_gender_chi2_tests <- glad_coping_participation_raw %>%
#   count(gender_recode, completed_baseline) %>%
#   spread(key = gender_recode, value = n) %>%
#   select(-completed_baseline) %>% 
#   pairwise_chisq_gof_test(
#     p.adjust.method = "BH"
#   ) %>%
#   mutate(
#     Comparison = paste(group1,"vs.",group2, sep = " "),
#     Effect = p.adj.signif
#   ) %>%
#   select(
#     Comparison,
#     Effect
#   ) %>%
#   pivot_longer(
#     cols = c("Effect"),
#     values_to = "Difference") %>%
#   select(-name) %>%
#   pivot_wider(
#     names_from = "Comparison",
#     values_from = "Difference")

```

```{r Create contingency table for age}

age_groups_contingency_table <- table(glad_coping_participation_raw$age_groups_labelled,
                                      glad_coping_participation_raw$completed_baseline_labelled)

#Check output
age_groups_contingency_table

```

```{r Create contingency table for gender}

gender_contingency_table <- table(glad_coping_participation_raw$gender_recode_labelled,
                                  glad_coping_participation_raw$completed_baseline_labelled)

#Check output
gender_contingency_table

```

```{r Create contingency table for ethnicity}

ethnicity_contingency_table <- table(glad_coping_participation_raw$ethnicity_labelled,
                                     glad_coping_participation_raw$completed_baseline_labelled)

#Check output
ethnicity_contingency_table

```

```{r Create contingency table for Education}

education_contingency_table <- table(glad_coping_participation_raw$highest_education,
                                     glad_coping_participation_raw$completed_baseline_labelled)

#Check output
education_contingency_table

```

```{r Create contingency table for employment}

employment_contingency_table <- table(glad_coping_participation_raw$employment_labelled,
                                      glad_coping_participation_raw$completed_baseline_labelled)

#Check output
employment_contingency_table

```

```{r Partnership status}

partnership_contingency_table <- table(glad_coping_participation_raw$partnership_status_labelled,
                                       glad_coping_participation_raw$completed_baseline_labelled)

#Check output
partnership_contingency_table

```

#Run aim 1 chi2 tests

The aim here is to see whether there are any significant differences between 
the GLAD Study paticipants who did and did not take part in the COPING baseline.

##Age

```{r Chi2 test for age}

age_groups_chi2_test <- chisq.test(age_groups_contingency_table,
           correct = TRUE)

#Check output
age_groups_chi2_test

```

```{r Create post_hoc function for sig chi2 results}

post_hoc_chi2_func <- function(contingency_table, correct_adj = FALSE, sig_level = 0.05){
  
  #Get the adjusted residuals
  chi2_result <- chisq.test(contingency_table,
             correct = correct_adj)$stdres
  
  #Make Bonferonni correction
  print(bonferroni <- sig_level/(nrow(contingency_table) * ncol(contingency_table)))
  
  #Get critical z value
  print(qnorm(bonferroni/2))

  return(chi2_result)
  
}

```

```{r Run follow-up tests for age groups}

post_hoc_chi2_func(age_groups_contingency_table,
              correct_adj = TRUE)

```

##Gender

```{r Chi2 test for gender}

gender_chi2_test <- chisq.test(gender_contingency_table,
           correct = TRUE)

#Check output
gender_chi2_test

```

```{r Post hoc testing for gender}

post_hoc_chi2_func(gender_contingency_table,
              correct_adj = TRUE)

```

##Ethnicity

```{r Chi2 test for ethnicity}

ethnicity_chi2_test <- chisq.test(ethnicity_contingency_table,
           correct = TRUE)

#Check output
ethnicity_chi2_test

```

```{r Post-hoc testing for ethnicity chi2}

post_hoc_chi2_func(ethnicity_contingency_table,
                   correct_adj = TRUE)

```

##Education

```{r Chi2 test for education}

education_chi2_test <- chisq.test(education_contingency_table,
           correct = TRUE)

#Check output
education_chi2_test

```

```{r Post-hoc testing for education chi2 test}

post_hoc_chi2_func(education_contingency_table,
                   correct_adj = TRUE)

```

##Employment

```{r Chi2 test for employment}

employment_chi2_test <- chisq.test(employment_contingency_table,
           correct = TRUE)

#Check output
employment_chi2_test

```

```{r Post-hoc testing for employment chi2 test}

post_hoc_chi2_func(employment_contingency_table,
                   correct_adj = TRUE)

```

##Partnership status

```{r Chi2 test for partnership status}

partnership_chi2_test <- chisq.test(partnership_contingency_table,
           correct = TRUE)

#Check output
partnership_chi2_test

```

```{r Post-hoc testing for partnership status chi2 test}

post_hoc_chi2_func(partnership_contingency_table,
                   correct_adj = TRUE)

```

#Aim 1 Logistic regression model

Our first aim is to see whether participation in the COPING baseline is 
explained by the sociodemographic, mental and physical health characteristics
of the GLAD Study participants.

```{r Run complete LR model}

#Note: Have left out the "depressive_and_anxiety_comorbidity_labelled" variable
#because this is acting as the reference group for MH diagnoses.

complete_LR_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    startDate + 
    kit_returned_labelled +
    joined_coping_first_invitation_labelled,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(complete_LR_model)

```

```{r Put complete LR model names into a vector}

#Put all LR variable names into vector in the order they appear in summary(model4)
complete_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode_labelledFemale",
  "gender_recode_labelledNon-binary/prefer to self-define",
  "highest_education_labelledA levels/AS levels or equivalent",
  "highest_education_labelledO levels/GCSEs or equivalent",
  "highest_education_labelledCSEs or equivalent",
  "highest_education_labelledNVQ or HND or HNC or equivalent",
  "highest_education_labelledNone of the above",
  "ethnicity_labelledMixed",
  "ethnicity_labelledAsian or Asian British",
  "ethnicity_labelledBlack or Black British",
  "ethnicity_labelledArab",
  "ethnicity_labelledOther",
  "employment_labelledRetired",
  "employment_labelledLooking after home and/or family",
  "employment_labelledUnable to work because of sickness or disability",
  "employment_labelledUnemployed",
  "employment_labelledDoing unpaid or voluntary work",
  "employment_labelledFull or part-time_student",
  "employment_labelledNone of the above",
  "partnership_status_labelledRelationship or married/civil partnership",
  "partnership_status_labelledDivorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelledI smoke now",
  "smoking_status_labelledI used to smoke",
  "physical_health_comorbidities_labelled1 physical health disorder",
  "physical_health_comorbidities_labelled2+ physical health disorders",
  "MH_disorders_total_count",
  "eating_disorders_labelledEating disorder",
  "OCRDs_labelledOCRDs",
  "psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
  "psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
  "psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
  "asd_labelledAutistic spectrum disorder",
  "ADHD_ADD_labelledADHD or ADD disorder",
  "mhd.personality_disorder_labelledPersonality disorder",
  "PTSD_labelledPost-traumatic stress disorder",
  "startDate",
  "kit_returnedPt has provided saliva kit",
  "joined_coping_first_invitationCompleted COPING baseline before 1st follow-up"
)

```

```{r Create tidy output for complete LR model}

#Create tidy model output
complete_LR_model_tidy <- tidy(
  complete_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = complete_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    adj.p.value = p.adjust(p.value, 
                           "bonferroni"),
    adj.significance = case_when(
      adj.p.value < 0.05 ~ "Significant",
      adj.p.value >= 0.05 ~ "Not-significant"
    )
  )

complete_LR_model_tidy %>% 
  head(nrow(complete_LR_model_tidy))

#Create kable output
#complete_LR_model_kable <- kable(complete_LR_model_tidy[-c(1), ],
#      digits = 2)

```

##Run exploratory LR model

During the analysis, we began to think that it may be circular to include
a measure of participation (providing a saliva kit for the GLAD study) as 
a predictor of participation. Therefore, we want to re-run the LR model
without the saliva kit predictor to see to what extent this influences the 
results.

```{r Run complete LR model}

exploratory_LR_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    startDate + 
    joined_coping_first_invitation_labelled,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(exploratory_LR_model)

```

```{r Put complete LR model names into a vector}

#Put all LR variable names into vector in the order they appear in summary(model4)
exploratory_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode_labelledFemale",
  "gender_recode_labelledNon-binary/prefer to self-define",
  "highest_education_labelledA levels/AS levels or equivalent",
  "highest_education_labelledO levels/GCSEs or equivalent",
  "highest_education_labelledCSEs or equivalent",
  "highest_education_labelledNVQ or HND or HNC or equivalent",
  "highest_education_labelledNone of the above",
  "ethnicity_labelledMixed",
  "ethnicity_labelledAsian or Asian British",
  "ethnicity_labelledBlack or Black British",
  "ethnicity_labelledArab",
  "ethnicity_labelledOther",
  "employment_labelledRetired",
  "employment_labelledLooking after home and/or family",
  "employment_labelledUnable to work because of sickness or disability",
  "employment_labelledUnemployed",
  "employment_labelledDoing unpaid or voluntary work",
  "employment_labelledFull or part-time_student",
  "employment_labelledNone of the above",
  "partnership_status_labelledRelationship or married/civil partnership",
  "partnership_status_labelledDivorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelledI smoke now",
  "smoking_status_labelledI used to smoke",
  "physical_health_comorbidities_labelled1 physical health disorder",
  "physical_health_comorbidities_labelled2+ physical health disorders",
  "MH_disorders_total_count",
  "eating_disorders_labelledEating disorder",
  "OCRDs_labelledOCRDs",
  "psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
  "psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
  "psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
  "asd_labelledAutistic spectrum disorder",
  "ADHD_ADD_labelledADHD or ADD disorder",
  "mhd.personality_disorder_labelledPersonality disorder",
  "PTSD_labelledPost-traumatic stress disorder",
  "startDate",
  "joined_coping_first_invitationCompleted COPING baseline before 1st follow-up"
)

```

```{r Create tidy output for complete LR model}

#Create tidy model output
exploratory_LR_model_tidy <- tidy(
  exploratory_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = exploratory_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    adj.p.value = p.adjust(p.value, 
                           "bonferroni"),
    adj.significance = case_when(
      adj.p.value < 0.05 ~ "Significant",
      adj.p.value >= 0.05 ~ "Not-significant"
    )
  )

exploratory_LR_model_tidy %>% 
  head(nrow(exploratory_LR_model_tidy))

```

#Test assumptions of complete LR model

Checking LR assumptions in R: 
http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/

##Multicollinearity

Check that all IVs are not highly correlated.

```{r Get VIF values of final model}

complete_LR_model_VIF <- complete_LR_model %>% 
  vif()

complete_LR_model_VIF

```

##Linearity

Check the relationship between the continuous predictor variables and the logit
of the DV. This can be inspected visually by creating scatterplots between each
predictor and the logit values.


Note: We have to remove values that have 0 because when you log transform
a variable, it throws an error if there are any 0's in the variable. See:
https://stackoverflow.com/questions/31177795/error-in-glm-in-r

```{r Remove observations that have 0 on the continuous variables}

glad_coping_participation_lin <- glad_coping_participation_raw %>% 
  filter(gad.sum_score != 0,
         phq.sum_score != 0,
         audit.sum_score != 0)

#Check new dimensions
glad_coping_participation_raw %>% 
  dim()

glad_coping_participation_lin %>% 
  dim()

```


```{r LR model with interaction terms for continuous variables}

linearity_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned*log(age_cleaned) +
    gad.sum_score*log(gad.sum_score) +
    phq.sum_score*log(phq.sum_score) +
    audit.sum_score*log(audit.sum_score),
  family = "binomial",
  data = glad_coping_participation_lin
)

linearity_model %>% 
  summary()

```

##Outliers

Anything > 1 is a cause for concern.

```{r Check cooks distance values in LR model}

plot(complete_LR_model,
     which = 4)

```

```{r Extract model results}

LR.model_data <- augment(complete_LR_model) %>% 
  mutate(index = 1:n())

#Check output
LR.model_data %>% 
  glimpse()

```

```{r Plot standardised residuals}

LR.model_data %>% 
  ggplot(aes(index, .std.resid)) +
  geom_point(aes(colour = completed_baseline_labelled), alpha = .5) +
  theme_minimal()

```

```{r Check standardised residuals > 3.3}

LR.model_data %>% 
  filter(abs(.std.resid) > 3.3)

```

#Zero-inflated negative binomial regression

```{r Run simplified ZINB model}

ZINB_model <- zeroinfl(
  formula = total_COPING_waves ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score +
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    #startDate + 
    kit_returned_labelled +
    joined_coping_first_invitation_labelled,
  data = glad_coping_participation_raw,
  dist = "negbin",
  #zero.dist = "binomial",
  link = "logit")

#Check output
summary(ZINB_model)

```

```{r exponentiate the ZINB coefficients}
exp(coef((ZINB_model)))
```

```{r ZINB as percentage}
round((exp(coef(ZINB_model))-1)*100)
```

Pseudo r-squared 
- use Nagelkerke (Cragg and Uhler) in the output regression summary table
```{r ZINB model nagelkerke}
nagelkerke(ZINB_model)
```

```{r Calculate confidence intervals for ZINB model}
confint(ZINB_model)
```

```{r Inspect tidy output from ZINB model}

stargazer(ZINB_model, 
          zero.component = FALSE, 
          type = "text")

```

---
title: "COPING_participation_analysis"
author: "Steven Bright"
date: "04/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean global environment}

remove(list = ls())

```

#Call libraries

```{r Install packages}

#install.packages("broom")
#install.packages("knitr)
#install.packages("car")
#install.packages("corrplot")
#install.packages("polycor")
#install.packages("tidyverse")

```

```{r Load libraries}

library(broom)
library(knitr)
library(car)
library(corrplot)
library(polycor)
library(tidyverse)

```

#Read in data

```{r Source paths}

source("..//COPING_participation_paths.r")

```

```{r Read in glad coping participation data}

glad_coping_participation_raw <- read_rds(paste0(processed_data_path, processed_data_name))

#Check data
glad_coping_participation_raw %>% 
  head()

```

#Create tables for chi2 tests

Sociodemographic variables:

Age (continuous - Not applicable)
Gender
Ethnicity
Education
Employment
Partnership status

```{r Create contingency table for gender}

gender_contingency_table <- table(glad_coping_participation_raw$gender_recode_labelled,
                                  glad_coping_participation_raw$completed_baseline_labelled)

#Check output
gender_contingency_table

```

```{r Create contingency table for ethnicity}

ethnicity_contingency_table <- table(glad_coping_participation_raw$ethnicity_labelled,
                                     glad_coping_participation_raw$completed_baseline_labelled)

#Check output
ethnicity_contingency_table

```

```{r Create contingency table for Education}

education_contingency_table <- table(glad_coping_participation_raw$highest_education,
                                     glad_coping_participation_raw$completed_baseline_labelled)

#Check output
education_contingency_table

```

```{r Create contingency table for employment}

employment_contingency_table <- table(glad_coping_participation_raw$employment_labelled,
                                      glad_coping_participation_raw$completed_baseline_labelled)

#Check output
employment_contingency_table

```

```{r Partnership status}

partnership_contingency_table <- table(glad_coping_participation_raw$partnership_status_labelled,
                                       glad_coping_participation_raw$completed_baseline_labelled)

#Check output
partnership_contingency_table

```

#Run aim 1 chi2 tests

The aim here is to see whether there are any significant differences between 
the GLAD Study paticipants who did and did not take part in the COPING baseline.

##Gender

This will only focus on the sociodemographic variables.

```{r Chi2 test for gender}

gender_chi2_test <- chisq.test(gender_contingency_table,
           correct = TRUE)

#Check output
gender_chi2_test

```

```{r Create post_hoc function for sig chi2 results}

post_hoc_chi2_func <- function(contingency_table, correct_adj = FALSE, sig_level = 0.05){
  
  #Get the adjusted residuals
  chi2_result <- chisq.test(contingency_table,
             correct = correct_adj)$stdres
  
  #Make Bonferonni correction
  print(bonferroni <- sig_level/(nrow(contingency_table) * ncol(contingency_table)))
  
  #Get critical z value
  print(qnorm(bonferroni/2))

  return(chi2_result)
  
}

```

```{r Post hoc testing for gender}

post_hoc_chi2_func(gender_contingency_table,
              correct_adj = TRUE)

```

##Ethnicity

```{r Chi2 test for ethnicity}

ethnicity_chi2_test <- chisq.test(ethnicity_contingency_table,
           correct = TRUE)

#Check output
ethnicity_chi2_test

```

```{r Post-hoc testing for ethnicity chi2}

post_hoc_chi2_func(ethnicity_contingency_table,
                   correct_adj = TRUE)

```

##Education

```{r Chi2 test for education}

education_chi2_test <- chisq.test(education_contingency_table,
           correct = TRUE)

#Check output
education_chi2_test

```

```{r Post-hoc testing for education chi2 test}

post_hoc_chi2_func(education_contingency_table,
                   correct_adj = TRUE)

```

##Employment

```{r Chi2 test for employment}

employment_chi2_test <- chisq.test(employment_contingency_table,
           correct = TRUE)

#Check output
employment_chi2_test

```

```{r Post-hoc testing for employment chi2 test}

post_hoc_chi2_func(employment_contingency_table,
                   correct_adj = TRUE)

```

##Partnership status

```{r Chi2 test for partnership status}

partnership_chi2_test <- chisq.test(partnership_contingency_table,
           correct = TRUE)

#Check output
partnership_chi2_test

```

```{r Post-hoc testing for partnership status chi2 test}

post_hoc_chi2_func(partnership_contingency_table,
                   correct_adj = TRUE)

```

#Run aim 1 Logistic regression models

We will run four logistic regression models for aim 1:

Model 1: Sociodemographic variables
Model 2: Psychiatric and health variables
Model 3: Study variables
Model 4: All variables together

##Model 1: sociodemograhic variables

```{r Run sociodemographic LR model}

sociodemographic_LR_model <- glm(
  formula = completed_baseline ~ age_cleaned + 
    gender_recode +
    highest_education +
    dem.questions_based_ethnic_origin +
    dem.what_is_your_current_employment_status +
    partnership_status,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(sociodemographic_LR_model)

```

```{r Create clean model output}

#Put sociodemographic variable names into vector in order that they appear in summary(model1)
sociodemographic_variable_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode",
  "highest_education",
  "dem.questions_based_ethnic_origin",
  "dem.what_is_your_current_employment",
  "partnership_status"
  )

#Create tidy model output
sociodemographic_LR_model_tidy <- tidy(
  sociodemographic_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = sociodemographic_variable_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
    `p value` = p.value,
    Significance
  )

sociodemographic_LR_model_tidy %>% 
  head(7)

#Create kable output
sociodemographic_LR_model_kable <- kable(sociodemographic_LR_model_tidy[-c(1), ],
      digits = 2)

```

##Model 2: Psychiatric and health

```{r Run psychiatric and health LR model}

#Need to add physical health comorbidity variable
psychiatric_and_health_LR_model <- glm(
  formula = completed_baseline ~ phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    dem.select_the_box_that_best_describes_you +
    physical_health_comorbidities +
    mental_health_comorbidities +
    depressive_and_anxiety_comorbidity +
    eating_disorders +
    OCRDs +
    psychotic_and_biploar_disorder +
    mhd.asd +
    mhd.addadhd +
    mhd.personality_disorder,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(psychiatric_and_health_LR_model)

```

```{r Create tidy psychiatric and health LR model}

#Put psychiatric and health variable names into vector in order that they appear in summary(model2)
psychiatric_and_health_variable_names <- c(
  "Intercept",
  "gad.sum_score",
  "phq.sum_score",
  "audit.sum_score",
  "dem.select_the_box_that_best_describes_you",
  "physical_health_comorbidities",
  "mental_health_comorbidities",
  "depressive_and_anxiety_comorbidity",
  "eating_disorders",
  "OCRDs",
  "psychotic_and_biploar_disorder",
  "mhd.asd",
  "mhd.addadhd",
  "mhd.personality_disorder"
  )

#Create tidy model output
psychiatric_and_health_LR_model_tidy <- tidy(
  psychiatric_and_health_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = psychiatric_and_health_variable_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
    `p value` = p.value,
    Significance
  )

psychiatric_and_health_LR_model_tidy %>% 
  head(14)

#Create kable output
psychiatric_and_health_LR_model_kable <- kable(psychiatric_and_health_LR_model_tidy[-c(1), ],
      digits = 2)

```

##Model 3: Study variables

```{r Run study variables LR model}

glad_study_variables_LR_model <- glm(
  formula = completed_baseline ~ startDate + 
    kit_returned +
    joined_coping_first_invitation,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(glad_study_variables_LR_model)

```

```{r Create clean GLAD study variables LR model}

#Put glad study variable names into vector in order that they appear in summary(model3)
glad_study_variable_names <- c(
  "Intercept",
  "startDate",
  "kit_returned",
  "joined_coping_first_invitation"
)

#Create tidy model output
glad_study_variables_LR_model_tidy <- tidy(
  glad_study_variables_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = glad_study_variable_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
    `p value` = p.value,
    Significance
  )

glad_study_variables_LR_model_tidy %>% 
  head()

#Create kable output
glad_study_variables_LR_model_kable <- kable(glad_study_variables_LR_model_tidy[-c(1), ],
      digits = 2)

```

##Complete LR model

```{r Run complete LR model}

complete_LR_model <- glm(
  formula = completed_baseline ~ age_cleaned + 
    gender_recode +
    highest_education +
    dem.questions_based_ethnic_origin +
    dem.what_is_your_current_employment_status +
    partnership_status +
    phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    dem.select_the_box_that_best_describes_you +
    physical_health_comorbidities +
    mental_health_comorbidities +
    depressive_and_anxiety_comorbidity +
    eating_disorders +
    OCRDs +
    psychotic_and_biploar_disorder +
    mhd.asd +
    mhd.addadhd +
    mhd.personality_disorder +
    startDate + 
    kit_returned +
    joined_coping_first_invitation,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(complete_LR_model)

```

```{r Create tidy complete LR model}

#Put all LR variable names into vector in the order they appear in summary(model4)
complete_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode",
  "highest_education",
  "dem.questions_based_ethnic_origin",
  "dem.what_is_your_current_employment_status",
  "partnership_status",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "dem.select_the_box_that_best_describes_you",
  "physical_health_comorbidities",
  "mental_health_comorbidities",
  "depressive_and_anxiety_comorbidity",
  "eating_disorders",
  "OCRDs",
  "psychotic_and_biploar_disorder",
  "mhd.asd",
  "mhd.addadhd",
  "mhd.personality_disorder",
  "startDate",
  "kit_returned",
  "joined_coping_first_invitation"
)

#Create tidy model output
complete_LR_model_tidy <- tidy(
  complete_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = complete_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
    `p value` = p.value,
    Significance
  )

complete_LR_model_tidy %>% 
  head(23)

#Create kable output
complete_LR_model_kable <- kable(complete_LR_model_tidy[-c(1), ],
      digits = 2)

```

#Test assumptions of complete LR model
##Multicollinearity

Check that all IVs are not highly correlated.

```{r Get VIF values of final model}

complete_LR_model_VIF <- complete_LR_model %>% 
  vif()

complete_LR_model_VIF

```

```{r Create correlation matrix}

#Select correlation variables
correlation_vars <- glad_coping_participation_raw %>% 
  select(complete_LR_model_names[-1], #Remove "Intercept"
         -startDate)

#Get correlations
all.corr.mat <- correlation_vars %>% 
  hetcor(use = "pairwise.complete.obs")

```

```{r Save cormat as a matrix object}

all.corr.matrix <- as.matrix(all.corr.mat)

```


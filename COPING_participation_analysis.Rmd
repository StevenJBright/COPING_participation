---
title: "COPING_participation_analysis"
author: "Steven Bright"
date: "04/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Clean global environment}

remove(list = ls())

```

```{r Turn scientific notation off}

#Change it to "= 0" to turn it back on
options(scipen = 999)

```

#Call libraries

```{r Install packages}

#install.packages("broom")
#install.packages("knitr)
#install.packages("car")
#install.packages("rstatix")
#install.packages("pscl")
#install.packages("stargazer")
#install.packages("boot")
#install.packages("stats")
#install.packages("rcompanion")
#install.packages("MASS")
#install.packages("tidyverse")

```

```{r Load libraries}

library(broom)
library(knitr)
library(car)
library(rstatix)
library(pscl)
library(stargazer)
library(boot)
library(stats)
library(rcompanion)
library(MASS)
library(tidyverse)

```

#Read in data

```{r Source paths}

source("..//COPING_participation_paths.r")

```

```{r Source functions}

source("..//COPING_participation_functions.r")

```

```{r Read in glad coping participation data}

glad_coping_participation_raw <- read_rds(paste0(processed_data_path, processed_data_name))

#Check data
glad_coping_participation_raw %>% 
  head()

```

#Aim 1 Logistic regression model

Our first aim is to see whether participation in the COPING baseline is 
explained by the sociodemographic, mental and physical health characteristics
of the GLAD Study participants.

```{r Run complete LR model}

#Note: Have left out the "depressive_and_anxiety_comorbidity_labelled" variable
#because this is acting as the reference group for MH diagnoses.

complete_LR_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    startDate + 
    kit_returned_labelled,
    #joined_coping_first_invitation_labelled,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(complete_LR_model)

```

```{r Calculate nagelkerke effect size}

complete_LR_model %>% 
  nagelkerke()

```

```{r Put complete LR model names into a vector}

#Put all LR variable names into vector in the order they appear in summary(model4)
complete_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode_labelledFemale",
  "gender_recode_labelledNon-binary/prefer to self-define",
  "highest_education_labelledA levels/AS levels or equivalent",
  "highest_education_labelledO levels/GCSEs or equivalent",
  "highest_education_labelledCSEs or equivalent",
  "highest_education_labelledNVQ or HND or HNC or equivalent",
  "highest_education_labelledNone of the above",
  "ethnicity_labelledMixed",
  "ethnicity_labelledAsian or Asian British",
  "ethnicity_labelledBlack or Black British",
  "ethnicity_labelledArab",
  "ethnicity_labelledOther",
  "employment_labelledRetired",
  "employment_labelledLooking after home and/or family",
  "employment_labelledUnable to work because of sickness or disability",
  "employment_labelledUnemployed",
  "employment_labelledDoing unpaid or voluntary work",
  "employment_labelledFull or part-time_student",
  "employment_labelledNone of the above",
  "partnership_status_labelledRelationship or married/civil partnership",
  "partnership_status_labelledDivorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelledI smoke now",
  "smoking_status_labelledI used to smoke",
  "physical_health_comorbidities_labelled1 physical health disorder",
  "physical_health_comorbidities_labelled2+ physical health disorders",
  "MH_disorders_total_count",
  "eating_disorders_labelledEating disorder",
  "OCRDs_labelledOCRDs",
  "psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
  "psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
  "psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
  "asd_labelledAutistic spectrum disorder",
  "ADHD_ADD_labelledADHD or ADD disorder",
  "mhd.personality_disorder_labelledPersonality disorder",
  "PTSD_labelledPost-traumatic stress disorder",
  "startDate",
  "kit_returnedPt has provided saliva kit"
  #"joined_coping_first_invitationCompleted COPING baseline before 1st follow-up"
)

```

```{r Create tidy output for complete LR model}

#Create tidy model output
complete_LR_model_tidy <- tidy(
  complete_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = complete_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    adj.p.value = p.adjust(p.value, 
                           "bonferroni"),
    adj_significance = if_else(
      adj.p.value < 0.05,
      1,
      0
    )
  )

complete_LR_model_tidy %>% 
  head(nrow(complete_LR_model_tidy))

#Create kable output
#complete_LR_model_kable <- kable(complete_LR_model_tidy[-c(1), ],
#      digits = 2)

```

##Run exploratory LR model

During the analysis, we began to think that it may be circular to include
a measure of participation (providing a saliva kit for the GLAD study) as 
a predictor of participation. Therefore, we want to re-run the LR model
without the saliva kit predictor to see to what extent this influences the 
results.

```{r Run exploratory  LR model}

exploratory_LR_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score + 
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    startDate,
    #kit_returned_labelled,
    #joined_coping_first_invitation_labelled,
  family = "binomial",
  data = glad_coping_participation_raw)

#Check output
summary(exploratory_LR_model)

```

```{r Calculate nagelkerke effect size}

exploratory_LR_model %>% 
  nagelkerke()

```

```{r Put complete LR model names into a vector}

#Put all LR variable names into vector in the order they appear in summary(model4)
exploratory_LR_model_names <- c(
  "Intercept",
  "age_cleaned",
  "gender_recode_labelledFemale",
  "gender_recode_labelledNon-binary/prefer to self-define",
  "highest_education_labelledA levels/AS levels or equivalent",
  "highest_education_labelledO levels/GCSEs or equivalent",
  "highest_education_labelledCSEs or equivalent",
  "highest_education_labelledNVQ or HND or HNC or equivalent",
  "highest_education_labelledNone of the above",
  "ethnicity_labelledMixed",
  "ethnicity_labelledAsian or Asian British",
  "ethnicity_labelledBlack or Black British",
  "ethnicity_labelledArab",
  "ethnicity_labelledOther",
  "employment_labelledRetired",
  "employment_labelledLooking after home and/or family",
  "employment_labelledUnable to work because of sickness or disability",
  "employment_labelledUnemployed",
  "employment_labelledDoing unpaid or voluntary work",
  "employment_labelledFull or part-time_student",
  "employment_labelledNone of the above",
  "partnership_status_labelledRelationship or married/civil partnership",
  "partnership_status_labelledDivorced/widowed/separated",
  "phq.sum_score",
  "gad.sum_score",
  "audit.sum_score",
  "smoking_status_labelledI smoke now",
  "smoking_status_labelledI used to smoke",
  "physical_health_comorbidities_labelled1 physical health disorder",
  "physical_health_comorbidities_labelled2+ physical health disorders",
  "MH_disorders_total_count",
  "eating_disorders_labelledEating disorder",
  "OCRDs_labelledOCRDs",
  "psychotic_and_biploar_disorder_labelledPsychotic and bipolar disorder",
  "psychotic_and_biploar_disorder_labelledOnly psychotic disorder",
  "psychotic_and_biploar_disorder_labelledOnly bipolar disorder",
  "asd_labelledAutistic spectrum disorder",
  "ADHD_ADD_labelledADHD or ADD disorder",
  "mhd.personality_disorder_labelledPersonality disorder",
  "PTSD_labelledPost-traumatic stress disorder",
  "startDate"
  #"joined_coping_first_invitationCompleted COPING baseline before 1st follow-up"
)

```

```{r Create tidy output for complete LR model}

#Create tidy model output
exploratory_LR_model_tidy <- tidy(
  exploratory_LR_model,
  exponentiate = T,
  conf.int = T) %>%
  mutate(
    Variable = exploratory_LR_model_names,
    Significance = if_else(
      p.value < 0.05, 
      1,
      0
      ) %>%
    recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )) %>%
  select(
    Variable,
    OR = estimate,
    `CI 95% lower` = conf.low,
    `CI 95% upper` = conf.high,
     p.value,
    Significance
  ) %>% 
  mutate(
    adj.p.value = p.adjust(p.value, 
                           "bonferroni"),
    adj_significance = if_else(
      adj.p.value < 0.05,
      1,
      0
    )
  )

exploratory_LR_model_tidy %>% 
  head(nrow(exploratory_LR_model_tidy))

```

#Test assumptions of complete LR model

Checking LR assumptions in R: 
http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/

##Multicollinearity

Check that all IVs are not highly correlated.

```{r Get VIF values of final model}

complete_LR_model_VIF <- complete_LR_model %>% 
  vif()

complete_LR_model_VIF

```

##Linearity

Check the relationship between the continuous predictor variables and the logit
of the DV. This can be inspected visually by creating scatterplots between each
predictor and the logit values.


Note: We have to remove values that have 0 because when you log transform
a variable, it throws an error if there are any 0's in the variable. See:
https://stackoverflow.com/questions/31177795/error-in-glm-in-r

```{r Remove observations that have 0 on the continuous variables}

glad_coping_participation_lin <- glad_coping_participation_raw %>% 
  filter(gad.sum_score != 0,
         phq.sum_score != 0,
         audit.sum_score != 0)

#Check new dimensions
glad_coping_participation_raw %>% 
  dim()

glad_coping_participation_lin %>% 
  dim()

```


```{r LR model with interaction terms for continuous variables}

linearity_model <- glm(
  formula = completed_baseline_labelled ~ age_cleaned*log(age_cleaned) +
    gad.sum_score*log(gad.sum_score) +
    phq.sum_score*log(phq.sum_score) +
    audit.sum_score*log(audit.sum_score),
  family = "binomial",
  data = glad_coping_participation_lin
)

linearity_model %>% 
  summary()

```

##Outliers

Anything > 1 is a cause for concern.

```{r Check cooks distance values in LR model}

plot(complete_LR_model,
     which = 4)

```

```{r Extract model results}

LR.model_data <- augment(complete_LR_model) %>% 
  mutate(index = 1:n())

#Check output
LR.model_data %>% 
  glimpse()

```

```{r Plot standardised residuals}

LR.model_data %>% 
  ggplot(aes(index, .std.resid)) +
  geom_point(aes(colour = completed_baseline_labelled), alpha = .5) +
  theme_minimal()

```

```{r Check standardised residuals > 3.3}

LR.model_data %>% 
  filter(abs(.std.resid) > 3.3)

```

#Aim 2 regression models

For aim 2, we want to see which variables are associated with participating
in the COPING follow-up surveys. We will run a zero-inflated negative binomial
regression to test for this. However, we will also run a negative binomial 
regression for comparison purposes as they're often reported together in a 
single table.

##Negative binomial regression

```{r Run negative binomial regression}

negative_binomial_model <- 
  MASS::glm.nb(total_COPING_waves ~ age_cleaned + 
                 gender_recode_labelled +
                 highest_education_labelled +
                 ethnicity_labelled +
                 employment_labelled +
                 partnership_status_labelled +
                 phq.sum_score +
                 gad.sum_score +
                 audit.sum_score +
                 smoking_status_labelled +
                 physical_health_comorbidities_labelled +
                 MH_disorders_total_count +
                 eating_disorders_labelled +
                 OCRDs_labelled +
                 psychotic_and_biploar_disorder_labelled +
                 asd_labelled +
                 ADHD_ADD_labelled +
                 personality_disorder_labelled +
                 PTSD_labelled +
                 #startDate + 
                 kit_returned_labelled,
                 #joined_coping_first_invitation_labelled,
               data = glad_coping_participation_raw
               )

summary(negative_binomial_model)

```

```{r Exponentiate the negative binomial coefficients}
negative_binomial_model$family$linkinv(coef(negative_binomial_model))
```

```{r COPING follow-up waves NB percentage}

round((negative_binomial_model$family$linkinv(coef(negative_binomial_model))-1)*100)

```

```{r Caclulate nagelkerke effect size for NB model}

negative_binomial_model %>% 
  nagelkerke()

```

```{r Get names of the predictors in the negative binomial model}

negative_binomial_names <- complete_LR_model_names[complete_LR_model_names %not_in% "startDate"]

#Check startDate has been removed
negative_binomial_names

```


```{r Create tidy output for the NB model}

negative_binomial_model_tidy <- negative_binomial_model %>% 
   tidy(
    conf.int = TRUE,
    exponentiate = TRUE
    ) %>% 
  mutate(
    Variable = negative_binomial_names,
    Significance = if_else(
      p.value < 0.05,
      1,
      0
    ) %>% 
      recode_factor(
        "0" = "Not-significant",
        "1" = "Significant"
      )
    )  %>% 
  dplyr::select(Variable,
    estimate,
    conf.low,
    conf.high,
    p.value,
    Significance,
    std.error,
    statistic #Z value
  ) %>% 
  mutate(
    adj.p.value = p.adjust(p.value, 
                           "bonferroni"),
    adj_significance = if_else(
      adj.p.value < 0.05,
      1,
      0
    )
  )

negative_binomial_model_tidy %>% 
  head(nrow(negative_binomial_model_tidy))

```

##Zero-inflated negative binomial regression

```{r Run ZINB model}

ZINB_model <- zeroinfl(
  formula = total_COPING_waves ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score +
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled +
    #startDate + 
    kit_returned_labelled,
    #joined_coping_first_invitation_labelled,
  data = glad_coping_participation_raw,
  dist = "negbin",
  #zero.dist = "binomial",
  link = "logit")

#Check output
summary(ZINB_model)

```

```{r Exponentiate the zero-inflated coefficients}
exp(coef((ZINB_model)))
```

```{r ZINB as percentage}
round((exp(coef(ZINB_model))-1)*100)
```

Pseudo r-squared 
- use Nagelkerke (Cragg and Uhler) in the output regression summary table
```{r ZINB model nagelkerke}
nagelkerke(ZINB_model)
```

```{r Calculate confidence intervals for ZINB model}
confint(ZINB_model)
```

```{r Get p-values of ZINB model}

ZINB_model_p_values <- parameters::p_value(ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
ZINB_model_p_values <- ZINB_model_p_values %>% 
  select(Parameter, p) %>% 
  filter(str_detect(Parameter, "count_"))

#Check results
ZINB_model_p_values

```

```{r Adjust the ZINB model p-values for multiple testing}

adj_ZINB_model_p_values <- ZINB_model_p_values$p %>% 
  p.adjust("bonferroni")

#Create a tibble with a 'signficiant' character column
adj_ZINB_model_p_values_tib <- tibble(
  adj_p = adj_ZINB_model_p_values,
  adj_significance = if_else(
    adj_p < 0.05,
    1,
    0
    )
  )

#Check results
adj_ZINB_model_p_values_tib

```


```{r Inspect tidy output from ZINB model}

stargazer(ZINB_model, 
          zero.component = FALSE, 
          type = "text")

```

##Exploratory ZINB model

In the same sense of the exploratory LR model, we want to run an exploratory
ZINB model without the sproviding a saliva kit variable to see if this influences
the results.

```{r Run exploratory ZINB model without saliva kit variable}

exploratory_ZINB_model <- zeroinfl(
  formula = total_COPING_waves ~ age_cleaned + 
    gender_recode_labelled +
    highest_education_labelled +
    ethnicity_labelled +
    employment_labelled +
    partnership_status_labelled +
    phq.sum_score +
    gad.sum_score +
    audit.sum_score +
    smoking_status_labelled +
    physical_health_comorbidities_labelled +
    MH_disorders_total_count +
    eating_disorders_labelled +
    OCRDs_labelled +
    psychotic_and_biploar_disorder_labelled +
    asd_labelled +
    ADHD_ADD_labelled +
    personality_disorder_labelled +
    PTSD_labelled,
    #startDate + 
    #kit_returned_labelled +
    #joined_coping_first_invitation_labelled,
  data = glad_coping_participation_raw,
  dist = "negbin",
  #zero.dist = "binomial",
  link = "logit")

#Check output
summary(exploratory_ZINB_model)

```

```{r Exponentiate the zero-inflated coefficients}
exp(coef((exploratory_ZINB_model)))
```

```{r ZINB as percentage}
round((exp(coef(exploratory_ZINB_model))-1)*100)
```

Pseudo r-squared 
- use Nagelkerke (Cragg and Uhler) in the output regression summary table
```{r ZINB model nagelkerke}
nagelkerke(exploratory_ZINB_model)
```

```{r Calculate confidence intervals for ZINB model}
confint(exploratory_ZINB_model)
```

```{r Get p-values of exploratory ZINB model}

exploratory_ZINB_model_p_values <- parameters::p_value(exploratory_ZINB_model)

#Remove all the rows referring to the negative binomial ("count") model
exploratory_ZINB_model_p_values <- exploratory_ZINB_model_p_values %>% 
  select(Parameter, p) %>% 
  filter(str_detect(Parameter, "count_"))

#Check results
exploratory_ZINB_model_p_values

```

```{r Adjust the exploratory ZINB model p-values for multiple testing}

adj_exploratory_ZINB_model_p_values <- exploratory_ZINB_model_p_values$p %>% 
  p.adjust("bonferroni")

#Create a tibble with a 'signficiant' character column
adj_exploratory_ZINB_model_p_values_tib <- tibble(
  adj_p = adj_exploratory_ZINB_model_p_values,
  adj_significance = if_else(
    adj_p < 0.05,
    1,
    0
    )
  )

#Check results
adj_exploratory_ZINB_model_p_values_tib

```
